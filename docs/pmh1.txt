{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "ecaecaef-112d-4353-80ae-763aef1cedd4",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "── \u001b[1mAttaching core tidyverse packages\u001b[22m ──────────────────────── tidyverse 2.0.0 ──\n",
      "\u001b[32m✔\u001b[39m \u001b[34mdplyr    \u001b[39m 1.1.3     \u001b[32m✔\u001b[39m \u001b[34mpurrr    \u001b[39m 1.0.2\n",
      "\u001b[32m✔\u001b[39m \u001b[34mforcats  \u001b[39m 1.0.0     \u001b[32m✔\u001b[39m \u001b[34mstringr  \u001b[39m 1.5.0\n",
      "\u001b[32m✔\u001b[39m \u001b[34mggplot2  \u001b[39m 3.4.4     \u001b[32m✔\u001b[39m \u001b[34mtibble   \u001b[39m 3.2.1\n",
      "\u001b[32m✔\u001b[39m \u001b[34mlubridate\u001b[39m 1.9.2     \u001b[32m✔\u001b[39m \u001b[34mtidyr    \u001b[39m 1.3.1\n",
      "── \u001b[1mConflicts\u001b[22m ────────────────────────────────────────── tidyverse_conflicts() ──\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n",
      "\u001b[36mℹ\u001b[39m Use the conflicted package (\u001b[3m\u001b[34m<http://conflicted.r-lib.org/>\u001b[39m\u001b[23m) to force all conflicts to become errors\n",
      "Installing package into ‘/home/jupyter/.R/library’\n",
      "(as ‘lib’ is unspecified)\n",
      "\n",
      "Installing package into ‘/home/jupyter/.R/library’\n",
      "(as ‘lib’ is unspecified)\n",
      "\n",
      "Installing package into ‘/home/jupyter/.R/library’\n",
      "(as ‘lib’ is unspecified)\n",
      "\n",
      "Installing package into ‘/home/jupyter/.R/library’\n",
      "(as ‘lib’ is unspecified)\n",
      "\n",
      "Installing package into ‘/home/jupyter/.R/library’\n",
      "(as ‘lib’ is unspecified)\n",
      "\n"
     ]
    }
   ],
   "source": [
    "\n",
    "library(readr)\n",
    "library(bigrquery)\n",
    "library(tidyverse)\n",
    "install.packages(\"jtools\")\n",
    "install.packages(\"rpart\")\n",
    "install.packages(\"rpart.plot\")\n",
    "library(sjPlot)\n",
    "library(jtools)\n",
    "library(tinytex)\n",
    "library(dplyr)\n",
    "library(ggplot2)\n",
    "library(rpart)\n",
    "library(rpart.plot)\n",
    "install.packages(\"emmeans\")\n",
    "library(emmeans)\n",
    "library(margins) \n",
    "install.packages(\"tidyr\")\n",
    "library(tidyr) \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "f3110f02-e3c5-401a-8897-cd6f51909745",
   "metadata": {},
   "outputs": [],
   "source": [
    "##download the demographic vararibles\n",
    "\n",
    "basic <-bq_dataset_query(query=\"SELECT *\n",
    "FROM `yhcr-prd-phm-bia-core.CB_MYSPACE_ED.mother_baby_race`\n",
    "where person_id is not null \", \n",
    "x = \"yhcr-prd-phm-bia-core.CB__MYSPACE_ED\")\n",
    "\n",
    "\n",
    "basic1 <- bq_table_download(basic)\n",
    "\n",
    "basic1  <-basic1  %>% \n",
    "  filter(child_person_id != 13153801)%>%filter(baby_year_of_birth!=2023)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "f32bad9e-f1ae-47f4-947c-9376a0db9ec9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [55,030 × 27] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                                         : int [1:55030] 10702086 11114603 10764139 894999 10760968 13441945 1633580 13591018 8350126 12559456 ...\n",
      " $ last_menstrual_period_date                                        : Date[1:55030], format: NA NA ...\n",
      " $ pregnancy_first_contact_date                                      : Date[1:55030], format: \"2021-12-06\" NA ...\n",
      " $ discharge_date_mother_maternity_services                          : Date[1:55030], format: \"2023-01-23\" \"2023-01-27\" ...\n",
      " $ support_status_mother_at_booking                                  : chr [1:55030] \"Y\" \"Y\" \"Y\" \"Y\" ...\n",
      " $ physical_disability_status_indicator_mother_at_booking            : chr [1:55030] \"0\" \"0\" \"0\" NA ...\n",
      " $ physical_disability_code_mother_at_booking                        : chr [1:55030] \"N\" NA \"N\" NA ...\n",
      " $ mental_health_prediction_and_detection_indicator_mother_at_booking: chr [1:55030] \"1\" \"1\" \"1\" \"0\" ...\n",
      " $ complex_social_factors_indicator_mother_at_booking                : chr [1:55030] NA NA NA NA ...\n",
      " $ person_height_in_meters_mother_at_booking                         : chr [1:55030] \"1.67\" \"1.69\" \"1.71\" NA ...\n",
      " $ person_weight_in_kilograms_mother_at_booking                      : chr [1:55030] \"111.400\" \"99.000\" \"81.000\" NA ...\n",
      " $ substance_use_status_mother_at_booking                            : chr [1:55030] \"03\" \"03\" \"03\" \"03\" ...\n",
      " $ employment_status_mother_at_booking                               : chr [1:55030] \"01\" \"01\" \"01\" \"01\" ...\n",
      " $ employment_status_mother_at_booking_desc                          : chr [1:55030] \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ smoking_status_mother_at_booking                                  : chr [1:55030] \"4\" \"4\" \"4\" \"4\" ...\n",
      " $ smoking_status_mother_at_booking_desc                             : chr [1:55030] \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ status_of_folic_acid_supplement_mother_at_booking                 : chr [1:55030] \"02\" \"02\" \"02\" \"02\" ...\n",
      " $ weekly_alcohol_units_mother_at_booking                            : chr [1:55030] \"0\" \"0\" \"0\" \"0\" ...\n",
      " $ child_person_id                                                   : int [1:55030] 14990929 14983170 14984291 14991299 14990935 13590580 14992736 14991730 14994288 13579390 ...\n",
      " $ baby_year_of_birth                                                : chr [1:55030] \"2022\" \"2022\" \"2022\" \"2022\" ...\n",
      " $ baby_month_of_birth                                               : chr [1:55030] \"9\" \"9\" \"10\" \"11\" ...\n",
      " $ date_of_pregnancy_outcome_current_fetus                           : Date[1:55030], format: \"2022-09-15\" \"2022-09-15\" ...\n",
      " $ fetal_order_fetus_outcome                                         : chr [1:55030] \"1\" \"1\" \"1\" \"1\" ...\n",
      " $ pregnancy_outcome_current_fetus_desc                              : chr [1:55030] \"Live birth\" \"Live birth\" \"Live birth\" \"Live birth\" ...\n",
      " $ birth_date                                                        : POSIXct[1:55030], format: NA NA ...\n",
      " $ ethnicity_source_value                                            : chr [1:55030] NA NA NA NA ...\n",
      " $ race_source_value                                                 : chr [1:55030] NA NA NA NA ...\n"
     ]
    }
   ],
   "source": [
    "str(basic1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 73,
   "id": "e53e4859-aae4-42cc-98c6-a3e11dfe6b07",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 7 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>4433</td><td>12.881%</td></tr>\n",
       "\t<tr><td>2017</td><td>5324</td><td>15.470%</td></tr>\n",
       "\t<tr><td>2018</td><td>5159</td><td>14.991%</td></tr>\n",
       "\t<tr><td>2019</td><td>5095</td><td>14.805%</td></tr>\n",
       "\t<tr><td>2020</td><td>4779</td><td>13.886%</td></tr>\n",
       "\t<tr><td>2021</td><td>4836</td><td>14.052%</td></tr>\n",
       "\t<tr><td>2022</td><td>4789</td><td>13.915%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 7 × 3\n",
       "\\begin{tabular}{lll}\n",
       " baby\\_year\\_of\\_birth & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & 4433 & 12.881\\%\\\\\n",
       "\t 2017 & 5324 & 15.470\\%\\\\\n",
       "\t 2018 & 5159 & 14.991\\%\\\\\n",
       "\t 2019 & 5095 & 14.805\\%\\\\\n",
       "\t 2020 & 4779 & 13.886\\%\\\\\n",
       "\t 2021 & 4836 & 14.052\\%\\\\\n",
       "\t 2022 & 4789 & 13.915\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 7 × 3\n",
       "\n",
       "| baby_year_of_birth &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| 2016 | 4433 | 12.881% |\n",
       "| 2017 | 5324 | 15.470% |\n",
       "| 2018 | 5159 | 14.991% |\n",
       "| 2019 | 5095 | 14.805% |\n",
       "| 2020 | 4779 | 13.886% |\n",
       "| 2021 | 4836 | 14.052% |\n",
       "| 2022 | 4789 | 13.915% |\n",
       "\n"
      ],
      "text/plain": [
       "  baby_year_of_birth count percent\n",
       "1 2016               4433  12.881%\n",
       "2 2017               5324  15.470%\n",
       "3 2018               5159  14.991%\n",
       "4 2019               5095  14.805%\n",
       "5 2020               4779  13.886%\n",
       "6 2021               4836  14.052%\n",
       "7 2022               4789  13.915%"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "basic1%>%\n",
    "  group_by(baby_year_of_birth) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "e0e9f161-d184-4255-b629-7f576cc141b0",
   "metadata": {},
   "outputs": [],
   "source": [
    "basic2 <- basic1 %>% \n",
    "  dplyr::mutate(Ethnicity = recode(race_source_value , \n",
    "                            \"Asian or Asian British: Pakistani - England and Wa\" = \"Asian Pakistani\", \n",
    "                            \"Other ethnic group: any other ethnic group - Engla\" = \"Others\", \n",
    "                            \"Mixed multiple ethnic groups: White and Asian - En\" = \"Others\", \n",
    "                            \"Mixed multiple ethnic groups: any other Mixed or m\" = \"Others\", \n",
    "                            \"Unknown/Refuse to say\" = \"NA\",\n",
    "                            \"White: Gypsy or Irish Traveller - England and Wale\" = \"Others\",\n",
    "                            \"Asian or Asian British: Bangladeshi - England and \" = \"Others\", \n",
    "                            \"Black or African or Caribbean or Black British: Ca\" = \"Others\", \n",
    "                            \"White: Irish - England and Wales ethnic category 2\" = \"Others\", \n",
    "                            \"Other ethnic group: Arab - England and Wales ethni\" = \"Others\", \n",
    "                            \"White: English or Welsh or Scottish or Northern Ir\" = \"White British\",\n",
    "                            \"White:Any other White background\"  = \"Others\", \n",
    "                            \"Asian or Asian British: Indian - England and Wales\" = \"Others\", \n",
    "                            \"Asian or Asian British: any other Asian background\" = \"Others\", \n",
    "                            \"Mixed multiple ethnic groups: White and Black Cari\" = \"Others\", \n",
    "                            \"Black or African or Caribbean or Black British: ot\" = \"Others\", \n",
    "                            \"Black or African or Caribbean or Black British: Af\" = \"Others\", \n",
    "                            \"Asian or Asian British: Chinese - England and Wale\" = \"Others\", \n",
    "                            \"Mixed multiple ethnic groups: White and Black Afri\" = \"Others\"),\n",
    "               smoking = recode(smoking_status_mother_at_booking, \n",
    "                            \"01\" = \"Current smoker\", \n",
    "                            \"1\" = \"Current smoker\", \n",
    "                            \"2\" = \"Ex-Smoker\", \n",
    "                            \"02\" = \"Ex-Smoker\", \n",
    "                            \"03\" = \"Ex-Smoker\",\n",
    "                            \"04\" = \"Ex-Smoker\", \n",
    "                            \"4\" = \"Never Smoked\", \n",
    "                            \"06\" = \"Never Smoked\", \n",
    "                            \"3\" = \"NA\", \n",
    "                            \"05\" = \"NA\",\n",
    "                            \"09\"  = \"NA\", \n",
    "                            \"Z\" = \"NA\"),\n",
    "        folic_acid = recode(status_of_folic_acid_supplement_mother_at_booking, \n",
    "                            \"01\" = \"taken prior to pregnancy\", \n",
    "                            \"02\" = \"start taking once pregnant\", \n",
    "                            \"03\" = \"not taken\", \n",
    "                            \"ZZ\" = \"NA\"),\n",
    "            Employment1 = recode(employment_status_mother_at_booking,\n",
    "                            \"01\" = \"Employed\", \n",
    "                            \"02\" = \"Unemployed and seeking work\", \n",
    "                            \"03\" = \"Student\",\n",
    "                            \"04\" = \"Long-term sick or disabled\",\n",
    "                            \"05\"= \"Homemaker not looking for work\",\n",
    "                            \"06\"= \"not working and not receiving benefits\",\n",
    "                            \"07\"= \"Unpaid voluntary work\", \n",
    "                            \"ZZ\"= \"NA\", \n",
    "                             \"UU\"= \"NA\"), \n",
    "                 Employment = recode(employment_status_mother_at_booking,\n",
    "                            \"01\" = \"Employed\", \n",
    "                            \"02\" = \"Unemployed and seeking work\", \n",
    "                            \"03\" = \"others\",\n",
    "                            \"04\" = \"others\",\n",
    "                            \"05\"= \"Homemaker not looking for work\",\n",
    "                            \"06\"= \"others\",\n",
    "                            \"07\"= \"others\", \n",
    "                            \"ZZ\"= \"NA\", \n",
    "                             \"UU\"= \"NA\"), \n",
    "                           \n",
    "        substance_abuse = recode(substance_use_status_mother_at_booking, \n",
    "                            \"01\" = \"currently using\", \n",
    "                            \"02\" = \"previously used\", \n",
    "                            \"03\" = \"never\",\n",
    "                             \"ZZ\"= \"NA\", \n",
    "                             \"UU\"= \"NA\" ),\n",
    "        support= recode(support_status_mother_at_booking, \n",
    "                        \"Y\"= \"yes\",\n",
    "                        \"N\"= \"no\",\n",
    "                        \"Z\"= \"NA\" ),\n",
    "                mental_health_prediction= recode(mental_health_prediction_and_detection_indicator_mother_at_booking, \n",
    "                        \"1\"= \"yes\",\n",
    "                        \"0\"= \"no\" ),\n",
    "              complex_social_factors_indicator= recode(complex_social_factors_indicator_mother_at_booking, \n",
    "                        \"1\"= \"yes\",\n",
    "                        \"0\"= \"no\" ) ) %>%\n",
    "   mutate(across(where(is.character), ~na_if(., \"NA\")))\n",
    "##calculating BMI\n",
    "basic2$weekly_alcohol_units<-as.numeric(basic2$weekly_alcohol_units_mother_at_booking)\n",
    "basic2$height <- as.numeric(basic2$person_height_in_meters_mother_at_booking )\n",
    "basic2$weight <- as.numeric(basic2$person_weight_in_kilograms_mother_at_booking)\n",
    "basic2<-basic2 %>% \n",
    "  mutate(BMI = round(weight/height^2, 2))%>% mutate(BMI = ifelse(BMI > 13, BMI, NA))\n",
    "\n",
    "\n",
    " basic2<- basic2%>%dplyr::select (person_id , child_person_id, baby_year_of_birth,  Ethnicity,Employment,\n",
    "support, physical_disability_code_mother_at_booking , mental_health_prediction, complex_social_factors_indicator, BMI, smoking, \n",
    "folic_acid, substance_abuse)%>%distinct(child_person_id, .keep_all=TRUE)%>%distinct()                           \n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "a168d1d7-e9af-440c-b5b1-50536049356d",
   "metadata": {},
   "outputs": [],
   "source": [
    "basic2<- basic2%>%dplyr::select (person_id , child_person_id, baby_year_of_birth,  Ethnicity,Employment,\n",
    "support, physical_disability_code_mother_at_booking , mental_health_prediction, complex_social_factors_indicator, BMI, smoking, \n",
    "folic_acid, substance_abuse)%>%distinct(child_person_id, .keep_all=TRUE)%>%distinct()                           \n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "84e8f7db-e1c5-42b9-9caa-6fcbf9470e48",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [34,415 × 13] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                 : int [1:34415] 10702086 11114603 10764139 894999 10760968 13441945 1633580 13591018 8350126 12559456 ...\n",
      " $ child_person_id                           : int [1:34415] 14990929 14983170 14984291 14991299 14990935 13590580 14992736 14991730 14994288 13579390 ...\n",
      " $ baby_year_of_birth                        : chr [1:34415] \"2022\" \"2022\" \"2022\" \"2022\" ...\n",
      " $ Ethnicity                                 : chr [1:34415] NA NA NA NA ...\n",
      " $ Employment                                : chr [1:34415] \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr [1:34415] \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr [1:34415] \"N\" NA \"N\" NA ...\n",
      " $ mental_health_prediction                  : chr [1:34415] \"yes\" \"yes\" \"yes\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr [1:34415] NA NA NA NA ...\n",
      " $ BMI                                       : num [1:34415] 39.9 34.7 27.7 NA NA ...\n",
      " $ smoking                                   : chr [1:34415] \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr [1:34415] \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr [1:34415] \"never\" \"never\" \"never\" \"never\" ...\n"
     ]
    }
   ],
   "source": [
    "str(basic2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "00adbf9b-8295-4248-a33f-f7b9b235a3bc",
   "metadata": {},
   "outputs": [],
   "source": [
    "##check for duplicate\n",
    "basic2 %>% \n",
    "group_by(child_person_id) %>% \n",
    "summarise(n = n())%>%arrange(desc(n))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "a2bfee4c-bd07-4250-823f-6c52d04d94cf",
   "metadata": {},
   "outputs": [],
   "source": [
    "##importing speaking english cohort\n",
    "\n",
    "lang <-bq_dataset_query(query=\"SELECT *\n",
    "FROM `yhcr-prd-phm-bia-core.CB_MYSPACE_ED.lan1`\n",
    "where person_id is not null \", \n",
    "x = \"yhcr-prd-phm-bia-core.CB__MYSPACE_ED\")\n",
    "\n",
    "\n",
    "lang1 <- bq_table_download(lang)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 90,
   "id": "eab32803-8655-42fa-86ad-068a46694f09",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 4 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>speaksenglish</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>54770</td><td>15579</td><td>58.4%</td></tr>\n",
       "\t<tr><td>54771</td><td> 7700</td><td>28.8%</td></tr>\n",
       "\t<tr><td>54772</td><td> 2664</td><td>10.0%</td></tr>\n",
       "\t<tr><td>NA   </td><td>  751</td><td>2.8% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 4 × 3\n",
       "\\begin{tabular}{lll}\n",
       " speaksenglish & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 54770 & 15579 & 58.4\\%\\\\\n",
       "\t 54771 &  7700 & 28.8\\%\\\\\n",
       "\t 54772 &  2664 & 10.0\\%\\\\\n",
       "\t NA    &   751 & 2.8\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 4 × 3\n",
       "\n",
       "| speaksenglish &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| 54770 | 15579 | 58.4% |\n",
       "| 54771 |  7700 | 28.8% |\n",
       "| 54772 |  2664 | 10.0% |\n",
       "| NA    |   751 | 2.8%  |\n",
       "\n"
      ],
      "text/plain": [
       "  speaksenglish count percent\n",
       "1 54770         15579 58.4%  \n",
       "2 54771          7700 28.8%  \n",
       "3 54772          2664 10.0%  \n",
       "4 NA              751 2.8%   "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "lang1%>%\n",
    "  group_by( speaksenglish) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "4989c52d-81ec-4e72-9d49-c2f16099e108",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Speaks_English</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>No </td><td> 2447</td><td>14%</td></tr>\n",
       "\t<tr><td>Yes</td><td>15579</td><td>86%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " Speaks\\_English & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t No  &  2447 & 14\\%\\\\\n",
       "\t Yes & 15579 & 86\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| Speaks_English &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| No  |  2447 | 14% |\n",
       "| Yes | 15579 | 86% |\n",
       "\n"
      ],
      "text/plain": [
       "  Speaks_English count percent\n",
       "1 No              2447 14%    \n",
       "2 Yes            15579 86%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "lang2<-lang1%>%select (person_id, speaksenglish )%>%mutate(Speaks_English=  recode(speaksenglish, \n",
    "                            \"54770\" = \"Yes\", \n",
    "                            \"54771\" = \"NA\", \n",
    "                            \"54772\" = \"No\"))%>%\n",
    "   mutate(across(where(is.character), ~na_if(., \"NA\")))%>%distinct()\n",
    "lan_yes<-lang2%>%filter(Speaks_English==\"Yes\")\n",
    "lan_no<-lang2%>%filter(Speaks_English==\"No\")\n",
    "\n",
    "lan_no1<-anti_join(lan_no,lan_yes, by=\"person_id\")\n",
    "lang3<- bind_rows(lan_yes, lan_no1)%>%distinct()%>%select(person_id, Speaks_English)\n",
    "lang3%>%\n",
    "  group_by(Speaks_English) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "42867b6a-8887-4cd7-b5ec-327c4738b491",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id)`\n"
     ]
    }
   ],
   "source": [
    "basic3<-left_join(basic2, lang3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "ed543fd1-c313-46e3-8e04-df489a16b46e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Interpreter_needed</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>24617</td><td>84%</td></tr>\n",
       "\t<tr><td>yes</td><td> 4810</td><td>16%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " Interpreter\\_needed & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 24617 & 84\\%\\\\\n",
       "\t yes &  4810 & 16\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| Interpreter_needed &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 24617 | 84% |\n",
       "| yes |  4810 | 16% |\n",
       "\n"
      ],
      "text/plain": [
       "  Interpreter_needed count percent\n",
       "1 no                 24617 84%    \n",
       "2 yes                 4810 16%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##interprertater neede or no based on CVT3 codes\n",
    "int <-bq_dataset_query(query=\"SELECT *\n",
    "FROM `yhcr-prd-phm-bia-core.CB_MYSPACE_ED.Interpreter`\n",
    "where person_id is not null \", \n",
    "x = \"yhcr-prd-phm-bia-core.CB__MYSPACE_ED\")\n",
    "\n",
    "\n",
    "int1 <- bq_table_download(int)\n",
    "int1%>%\n",
    "  group_by( Interpreter_needed) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "db1ca6f9-b2ac-4f20-bbd9-e59cb47b1c2d",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Interpreter_needed</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>19807</td><td>80%</td></tr>\n",
       "\t<tr><td>yes</td><td> 4810</td><td>20%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " Interpreter\\_needed & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 19807 & 80\\%\\\\\n",
       "\t yes &  4810 & 20\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| Interpreter_needed &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 19807 | 80% |\n",
       "| yes |  4810 | 20% |\n",
       "\n"
      ],
      "text/plain": [
       "  Interpreter_needed count percent\n",
       "1 no                 19807 80%    \n",
       "2 yes                 4810 20%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##keep only one recordes for each case\n",
    "\n",
    "int_yes<-int1%>%filter(Interpreter_needed==\"yes\")\n",
    "int_no<-int1%>%filter(Interpreter_needed==\"no\")\n",
    "\n",
    "int_no1<-anti_join(int_no,int_yes, by=\"person_id\")\n",
    "int2<- bind_rows(int_yes, int_no1)%>%distinct()\n",
    "int2%>%\n",
    "  group_by( Interpreter_needed) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "15cafc76-e3b7-486c-b6dc-f21de1f25042",
   "metadata": {},
   "outputs": [],
   "source": [
    "int2 %>% \n",
    "group_by(person_id) %>% \n",
    "summarise(n = n())%>%arrange(desc(n))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "c4011b58-d9bd-43f1-85f7-3344dd72bbe4",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id)`\n"
     ]
    }
   ],
   "source": [
    "basic3<-left_join(basic3, int2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "e1bdacf0-4ec6-4dae-8d4c-609af611f48e",
   "metadata": {},
   "outputs": [],
   "source": [
    "##importing the multiple deprivation index file IMD\n",
    "IMD <-bq_dataset_query(query=\"SELECT *\n",
    "FROM `yhcr-prd-phm-bia-core.CB_MYSPACE_ED.pmh_IMD1`\n",
    "where person_id is not null \",\n",
    "x = \"yhcr-prd-phm-bia-core.CB__MYSPACE_ED\")\n",
    "\n",
    "\n",
    "IMD1 <- bq_table_download(IMD)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "a174ad8e-a9dd-4bba-81bd-a071889af96f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [36,871 × 2] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id: int [1:36871] 13704193 12952580 13606661 12506887 13206538 13352972 13027341 12524302 13569553 13671185 ...\n",
      " $ IMD      : num [1:36871] NA NA NA NA NA NA NA NA NA NA ...\n"
     ]
    }
   ],
   "source": [
    "str(IMD1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "b1ec270f-9fc7-48c6-9311-1b9055d37426",
   "metadata": {},
   "outputs": [],
   "source": [
    "##there were multiple IMD scores per case (IMD depending on the address), \n",
    "##first only people with one recordes will be kept then \n",
    "##the other with multiple recordes will be coneccted to theier address on the year of baby born \n",
    "##finally the IMD will be catergorised to 3 main categories  and only cases with one records will be kept \n",
    "\n",
    "IMD1a<-IMD1%>%distinct()%>%drop_na()\n",
    "IMD2<- IMD1a%>%mutate(IMD=case_when(IMD >= 7  & IMD <= 10 ~ \"least deprived\",\n",
    "                                      IMD >= 4  & IMD <= 6 ~ \"moderate deprived\",\n",
    "                                       IMD <= 3 ~ \"most deprived\"))%>%distinct()%>%add_count(person_id)\n",
    "IMD2a<-IMD2%>%filter(n==1)%>%distinct()\n",
    "IMD2b<-IMD2%>%filter(n!=1)%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "0bdc87ea-a17d-46f9-a27c-dfa0e60c9c6a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>n</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2</td><td>1673</td><td>96%</td></tr>\n",
       "\t<tr><td>3</td><td>  69</td><td>4% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " n & count & percent\\\\\n",
       " <int> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2 & 1673 & 96\\%\\\\\n",
       "\t 3 &   69 & 4\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| n &lt;int&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| 2 | 1673 | 96% |\n",
       "| 3 |   69 | 4%  |\n",
       "\n"
      ],
      "text/plain": [
       "  n count percent\n",
       "1 2 1673  96%    \n",
       "2 3   69  4%     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "IMD2b%>%\n",
    "  group_by( n) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "c2bd7e17-ea8d-48fa-975d-de75e70d485e",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id)`\n"
     ]
    }
   ],
   "source": [
    "## joining the basic file \n",
    "basic3<-left_join(basic3, IMD2a)%>%distinct()%>%select(-n)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "5bc7dff2-f421-4b31-b7b6-4b1f32c31265",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [34,415 × 16] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                 : int [1:34415] 10702086 11114603 10764139 894999 10760968 13441945 1633580 13591018 8350126 12559456 ...\n",
      " $ child_person_id                           : int [1:34415] 14990929 14983170 14984291 14991299 14990935 13590580 14992736 14991730 14994288 13579390 ...\n",
      " $ baby_year_of_birth                        : chr [1:34415] \"2022\" \"2022\" \"2022\" \"2022\" ...\n",
      " $ Ethnicity                                 : chr [1:34415] NA NA NA NA ...\n",
      " $ Employment                                : chr [1:34415] \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr [1:34415] \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr [1:34415] \"N\" NA \"N\" NA ...\n",
      " $ mental_health_prediction                  : chr [1:34415] \"yes\" \"yes\" \"yes\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr [1:34415] NA NA NA NA ...\n",
      " $ BMI                                       : num [1:34415] 39.9 34.7 27.7 NA NA ...\n",
      " $ smoking                                   : chr [1:34415] \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr [1:34415] \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr [1:34415] \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr [1:34415] \"Yes\" \"Yes\" NA \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr [1:34415] \"yes\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr [1:34415] \"most deprived\" \"moderate deprived\" NA NA ...\n"
     ]
    }
   ],
   "source": [
    "str(basic3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "97ef29cc-aa42-49ee-b24e-d43ce45d33d3",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 4 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>IMD</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>least deprived   </td><td>  958</td><td>3.7% </td></tr>\n",
       "\t<tr><td>moderate deprived</td><td> 1845</td><td>7.0% </td></tr>\n",
       "\t<tr><td>most deprived    </td><td>17238</td><td>65.7%</td></tr>\n",
       "\t<tr><td>NA               </td><td> 6192</td><td>23.6%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 4 × 3\n",
       "\\begin{tabular}{lll}\n",
       " IMD & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t least deprived    &   958 & 3.7\\% \\\\\n",
       "\t moderate deprived &  1845 & 7.0\\% \\\\\n",
       "\t most deprived     & 17238 & 65.7\\%\\\\\n",
       "\t NA                &  6192 & 23.6\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 4 × 3\n",
       "\n",
       "| IMD &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| least deprived    |   958 | 3.7%  |\n",
       "| moderate deprived |  1845 | 7.0%  |\n",
       "| most deprived     | 17238 | 65.7% |\n",
       "| NA                |  6192 | 23.6% |\n",
       "\n"
      ],
      "text/plain": [
       "  IMD               count percent\n",
       "1 least deprived      958 3.7%   \n",
       "2 moderate deprived  1845 7.0%   \n",
       "3 most deprived     17238 65.7%  \n",
       "4 NA                 6192 23.6%  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "basic3%>%\n",
    "  group_by( IMD) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "3bfbba92-77c8-458c-ab5b-239c2985fc3d",
   "metadata": {},
   "outputs": [
    {
     "ename": "ERROR",
     "evalue": "Error in is.data.frame(x): object 'basic3' not found\n",
     "output_type": "error",
     "traceback": [
      "Error in is.data.frame(x): object 'basic3' not found\nTraceback:\n",
      "1. write.csv(basic3, \"basic.csv\")",
      "2. eval.parent(Call)",
      "3. eval(expr, p)",
      "4. eval(expr, p)",
      "5. utils::write.table(basic3, \"basic.csv\", col.names = NA, sep = \",\", \n .     dec = \".\", qmethod = \"double\")",
      "6. is.data.frame(x)"
     ]
    }
   ],
   "source": [
    "write.csv(basic3,\"basic.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "90e67b75-8baa-4b7b-99a4-e6651fef90a4",
   "metadata": {},
   "outputs": [],
   "source": [
    "basic3<-read.csv(\"basic.csv\", na.strings = c(\"\", \"NA\"))%>%select(-X)%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 76,
   "id": "9686be08-fe2d-4d7a-bc72-40b05e6da736",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Auto-refreshing stale OAuth token.\n",
      "\n"
     ]
    }
   ],
   "source": [
    "###importing the pmh cohorts\n",
    "\n",
    "pmh <-bq_dataset_query(query=\"SELECT *\n",
    "FROM `yhcr-prd-phm-bia-core.CB_MYSPACE_ED.pmh`\n",
    "where person_id is not null \", \n",
    "x = \"yhcr-prd-phm-bia-core.CB__MYSPACE_ED\")\n",
    "pmh1 <- bq_table_download(pmh)%>%\n",
    "filter(child_person_id != 13153801 )%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 77,
   "id": "a9cc7150-e2e0-4440-961e-0483b5a9f310",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [180,359 × 15] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id      : int [1:180359] 13603832 13603832 13603832 13603832 13164082 13164082 13164082 13164082 13164082 13164082 ...\n",
      " $ child_person_id: int [1:180359] 12982784 12982784 12982784 12982784 13572864 13572864 13572864 13572864 13572864 13572864 ...\n",
      " $ mother_age     : int [1:180359] NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ event_year     : int [1:180359] 2017 2017 2017 2017 2017 2016 2016 2016 2016 2017 ...\n",
      " $ event_period   : chr [1:180359] \"postnatal\" \"antenatal\" \"postnatal\" \"postnatal\" ...\n",
      " $ PMH            : chr [1:180359] \"yes\" \"no\" \"no\" \"yes\" ...\n",
      " $ PMH_screening  : chr [1:180359] \"yes\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_problems   : chr [1:180359] \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ PMH_mangment   : chr [1:180359] \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ PMH_care       : chr [1:180359] \"no\" \"no\" \"no\" \"Care mild\" ...\n",
      " $ Depression     : chr [1:180359] \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Anxiety        : chr [1:180359] \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_others     : chr [1:180359] \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Family_history : chr [1:180359] \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication : chr [1:180359] \"no\" \"no\" \"no\" \"no\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "e2cde3d6-0f11-4c54-9f98-d373ea9f4ad3",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>PMH_screening</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>32274</td><td>53.4%</td></tr>\n",
       "\t<tr><td>yes</td><td>28155</td><td>46.6%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " PMH\\_screening & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 32274 & 53.4\\%\\\\\n",
       "\t yes & 28155 & 46.6\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| PMH_screening &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 32274 | 53.4% |\n",
       "| yes | 28155 | 46.6% |\n",
       "\n"
      ],
      "text/plain": [
       "  PMH_screening count percent\n",
       "1 no            32274 53.4%  \n",
       "2 yes           28155 46.6%  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh1%>%\n",
    "  group_by(PMH_screening) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 78,
   "id": "88dab30f-40e3-4705-9dd6-1854e865aba5",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id, child_person_id)`\n"
     ]
    }
   ],
   "source": [
    "pmh_final<-left_join(basic3, pmh1,relationship =  \"many-to-many\")%>%distinct()%>%filter(baby_year_of_birth!=2023)%>% distinct()   "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "id": "c7791f36-9de1-42f0-b30a-667b0bfa077a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t182079 obs. of  27 variables:\n",
      " $ person_id                                 : int  10702086 10702086 10702086 10702086 11114603 11114603 11114603 11114603 11114603 11114603 ...\n",
      " $ child_person_id                           : int  14990929 14990929 14990929 14990929 14983170 14983170 14983170 14983170 14983170 14983170 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2022 2022 2022 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  \"N\" \"N\" \"N\" \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  39.9 39.9 39.9 39.9 34.7 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ IMD                                       : chr  \"most deprived\" \"most deprived\" \"most deprived\" \"most deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ event_year                                : int  2022 2022 2023 2022 2022 2022 2021 2023 2023 2022 ...\n",
      " $ event_period                              : chr  NA \"antenatal\" \"postnatal\" \"postnatal\" ...\n",
      " $ PMH                                       : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_screening                             : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_problems                              : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_mangment                              : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_care                                  : chr  NA NA NA NA ...\n",
      " $ Depression                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Anxiety                                   : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_others                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh_final)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "5e9fcea0-7f25-44d7-9d98-f510b6583215",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh_final<-pmh_final%>%\n",
    "  mutate(across(where(is.character), as.factor))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "f533a3ed-c62d-4093-a37b-11a0c393f911",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 3 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>pmh_medication</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>24556</td><td>91.2%</td></tr>\n",
       "\t<tr><td>yes</td><td>  486</td><td>1.8% </td></tr>\n",
       "\t<tr><td>NA </td><td> 1879</td><td>7.0% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 3 × 3\n",
       "\\begin{tabular}{lll}\n",
       " pmh\\_medication & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 24556 & 91.2\\%\\\\\n",
       "\t yes &   486 & 1.8\\% \\\\\n",
       "\t NA  &  1879 & 7.0\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 3 × 3\n",
       "\n",
       "| pmh_medication &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 24556 | 91.2% |\n",
       "| yes |   486 | 1.8%  |\n",
       "| NA  |  1879 | 7.0%  |\n",
       "\n"
      ],
      "text/plain": [
       "  pmh_medication count percent\n",
       "1 no             24556 91.2%  \n",
       "2 yes              486 1.8%   \n",
       "3 NA              1879 7.0%   "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "###medication mental health problems\n",
    "pmh_final%>%\n",
    "  group_by( pmh_medication) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "90cb0f53-5b25-4654-a7a3-85458f65322e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>pmh_medication</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>31669</td><td>98%</td></tr>\n",
       "\t<tr><td>yes</td><td>  517</td><td>2% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " pmh\\_medication & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 31669 & 98\\%\\\\\n",
       "\t yes &   517 & 2\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| pmh_medication &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 31669 | 98% |\n",
       "| yes |   517 | 2%  |\n",
       "\n"
      ],
      "text/plain": [
       "  pmh_medication count percent\n",
       "1 no             31669 98%    \n",
       "2 yes              517 2%     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "###PMH medication\n",
    "##cleaning the data for medication\n",
    "pmhmd_true<-pmh_final%>%filter(pmh_medication==\"yes\")%>%distinct()\n",
    "pmhmd_false<-pmh_final%>%filter(pmh_medication==\"no\")%>%distinct()\n",
    "pmhmd1_false1<-anti_join(pmhmd_false, pmhmd_true, by=\"child_person_id\")%>%distinct()\n",
    "pmh_med<- bind_rows(pmhmd_true,pmhmd1_false1)%>%select(child_person_id, pmh_medication)%>%distinct()\n",
    "pmh_med%>%\n",
    "  group_by( pmh_medication) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d7a201d1-385c-47a5-bf70-1b25dca5bc0b",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh_med %>% \n",
    "group_by( child_person_id) %>% \n",
    "summarise(n = n())%>%arrange(desc(n))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "id": "ce6a8541-405d-4d1b-aac4-1e4e0a18cfbe",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Family_history</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>22830</td><td>93%</td></tr>\n",
       "\t<tr><td>yes</td><td> 1726</td><td>7% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 3\n",
       "\\begin{tabular}{lll}\n",
       " Family\\_history & count & percent\\\\\n",
       " <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & 22830 & 93\\%\\\\\n",
       "\t yes &  1726 & 7\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 3\n",
       "\n",
       "| Family_history &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| no  | 22830 | 93% |\n",
       "| yes |  1726 | 7%  |\n",
       "\n"
      ],
      "text/plain": [
       "  Family_history count percent\n",
       "1 no             22830 93%    \n",
       "2 yes             1726 7%     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##Family history\n",
    "##cleaning the data for family history\n",
    "pmhfh_true<-pmh_final%>%filter(Family_history==\"yes\")%>%distinct()\n",
    "pmhfh_false<-pmh_final%>%filter(Family_history==\"no\")%>%distinct()\n",
    "pmhfh1_false1<-anti_join(pmhfh_false, pmhfh_true, by=\"person_id\")%>%distinct()\n",
    "pmh_fh<- bind_rows(pmhfh_true,pmhfh1_false1)%>%select(person_id, Family_history)%>%distinct()\n",
    "pmh_fh%>%\n",
    "  group_by( Family_history) %>%\n",
    "  summarize(count = n_distinct(person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "ccfa0f64-b7d5-4ec6-8e75-4110e6175c68",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t24556 obs. of  2 variables:\n",
      " $ person_id     : int  13051651 12478884 13050236 12831543 13221408 13455289 12867781 12661894 12788439 13153450 ...\n",
      " $ Family_history: Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh_fh)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 79,
   "id": "79d1e6da-e8c2-4dd0-9268-b2c568ec0f9d",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh_final<-pmh_final%>% select(-c(Family_history, pmh_medication))%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 40,
   "id": "92efb987-4e05-40d6-8023-3ddafc19ef81",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t182079 obs. of  27 variables:\n",
      " $ person_id                                 : int  10702086 10702086 10702086 10702086 11114603 11114603 11114603 11114603 11114603 11114603 ...\n",
      " $ child_person_id                           : int  14990929 14990929 14990929 14990929 14983170 14983170 14983170 14983170 14983170 14983170 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2022 2022 2022 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  \"N\" \"N\" \"N\" \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  39.9 39.9 39.9 39.9 34.7 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ IMD                                       : chr  \"most deprived\" \"most deprived\" \"most deprived\" \"most deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ event_year                                : int  2022 2022 2023 2022 2022 2022 2021 2023 2023 2022 ...\n",
      " $ event_period                              : chr  NA \"antenatal\" \"postnatal\" \"postnatal\" ...\n",
      " $ PMH                                       : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_screening                             : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_problems                              : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_mangment                              : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_care                                  : chr  NA NA NA NA ...\n",
      " $ Depression                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Anxiety                                   : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_others                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh_final)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 80,
   "id": "dec9b829-c62b-4602-8c7c-a653460aebcb",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id)`\n",
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    }
   ],
   "source": [
    "pmh_final<-left_join(pmh_final,pmh_fh)%>%distinct()\n",
    "pmh_final<-left_join(pmh_final, pmh_med)%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4c6414a7-82c7-4981-a46d-7e8ba83fb785",
   "metadata": {},
   "outputs": [],
   "source": [
    "####################################################################### Screening for PMH problems  ###############################"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 50,
   "id": "a4a3b715-1187-422c-ab44-8a44746ecca9",
   "metadata": {},
   "outputs": [],
   "source": [
    "##recognition of PMH problems\n",
    "##cleaning the data (if have both yes and no for pmh  choose only yes)\n",
    "pmh_true<-pmh_final%>%filter(PMH==\"yes\")%>%distinct()\n",
    "pmh_false<-pmh_final%>%filter(PMH==\"no\")%>%distinct()\n",
    "pmh1_false1<-anti_join(pmh_false, pmh_true, by=\"child_person_id\")%>%distinct()\n",
    "pmh4<- bind_rows(pmh_true,pmh1_false1)%>%filter(event_year!=2015)%>% dplyr::select(-c(event_year))%>%distinct()                                                                    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "id": "83ce404c-168d-44e3-85e1-645268119201",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t54948 obs. of  28 variables:\n",
      " $ person_id                                 : int  11114603 10764139 894999 894999 894999 894999 894999 894999 894999 894999 ...\n",
      " $ child_person_id                           : int  14983170 14984291 14991299 14991299 14991299 14991299 14991299 14991299 14991299 14991299 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2022 2022 2022 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"N\" NA NA ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  34.7 27.7 NA NA NA ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" NA \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  \"moderate deprived\" NA NA NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ event_period                              : chr  \"postnatal\" \"antenatal\" \"antenatal\" \"postnatal\" ...\n",
      " $ PMH                                       : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ PMH_screening                             : chr  \"yes\" \"yes\" \"no\" \"no\" ...\n",
      " $ PMH_problems                              : chr  \"no\" \"no\" \"yes\" \"yes\" ...\n",
      " $ PMH_mangment                              : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ PMH_care                                  : chr  NA NA NA NA ...\n",
      " $ Depression                                : chr  \"no\" \"no\" \"yes\" \"no\" ...\n",
      " $ Anxiety                                   : chr  \"no\" \"no\" \"yes\" \"no\" ...\n",
      " $ PMH_others                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "f4355e7d-f7b7-4868-a26c-8114ae57e643",
   "metadata": {},
   "outputs": [],
   "source": [
    "write.csv(pmh4,\"pmh4.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "a5badca0-9d66-49e9-b978-0921926a458d",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh4<-read.csv(\"pmh4.csv\", na.strings = c(\"\", \"NA\"))%>%select(-X)%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "7fe29f26-cd08-4947-ae05-30c46c803eff",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t54948 obs. of  28 variables:\n",
      " $ person_id                                 : int  11114603 10764139 894999 894999 894999 894999 894999 894999 894999 894999 ...\n",
      " $ child_person_id                           : int  14983170 14984291 14991299 14991299 14991299 14991299 14991299 14991299 14991299 14991299 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2022 2022 2022 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"N\" NA NA ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  34.7 27.7 NA NA NA ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" NA \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  \"moderate deprived\" NA NA NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ event_period                              : chr  \"postnatal\" \"antenatal\" \"antenatal\" \"postnatal\" ...\n",
      " $ PMH                                       : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ PMH_screening                             : chr  \"yes\" \"yes\" \"no\" \"no\" ...\n",
      " $ PMH_problems                              : chr  \"no\" \"no\" \"yes\" \"yes\" ...\n",
      " $ PMH_mangment                              : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ PMH_care                                  : chr  NA NA NA NA ...\n",
      " $ Depression                                : chr  \"no\" \"no\" \"yes\" \"no\" ...\n",
      " $ Anxiety                                   : chr  \"no\" \"no\" \"yes\" \"no\" ...\n",
      " $ PMH_others                                : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "id": "3973b15c-c06d-4831-8716-abcc221bf1e1",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32169 obs. of  21 variables:\n",
      " $ person_id                                 : int  11114603 10764139 894999 10760968 1633580 13591018 8350126 12559456 13288085 12680799 ...\n",
      " $ child_person_id                           : int  14983170 14984291 14991299 14990935 14992736 14991730 14994288 13579390 13638429 12463954 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2016 2017 2016 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"N\" NA \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"no\" \"yes\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  34.7 27.7 NA NA 23.6 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"taken prior to pregnancy\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" NA \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  \"moderate deprived\" NA NA \"most deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH                                       : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period                              : chr  \"Postnatal\" \"Antenatal\" \"Both\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##changing perinatl period to 3 categories \"recognation\"\n",
    "pmh51<-pmh4%>%count(child_person_id, event_period,sort=TRUE)\n",
    " wide5=pmh51%>%spread(event_period, n)\n",
    " wide5$antenatal<-ifelse(is.na(wide5$antenatal), \"No\",\"Yes\")\n",
    "wide5$postnatal<-ifelse(is.na(wide5$postnatal), \"No\",\"Yes\")\n",
    "wide51<-wide5%>% mutate(Event_period= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period)\n",
    "pmh52<-pmh4%>%dplyr::select(-c(event_period,PMH_problems, Depression, Anxiety,,PMH_screening,PMH_care,PMH_mangment, PMH_others  ))%>%distinct()\n",
    "pmh52<-left_join(pmh52, wide51)%>%distinct()\n",
    "str(pmh52)\n",
    "write.csv(pmh52,\"pmh52.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "id": "ec075ff3-f913-48c4-a18a-5f7300cd0389",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  11114603 10764139 894999 10760968 1633580 13591018 8350126 12559456 13288085 12680799 ...\n",
      " $ child_person_id                           : int  14983170 14984291 14991299 14990935 14992736 14991730 14994288 13579390 13638429 12463954 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2022 2022 2022 2022 2016 2017 2016 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"N\" NA \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"yes\" \"no\" \"yes\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA NA NA ...\n",
      " $ BMI                                       : num  34.7 27.7 NA NA 23.6 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"taken prior to pregnancy\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" NA \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  \"moderate deprived\" NA NA \"most deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH_screening                             : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_s                            : chr  \"Postnatal\" \"Antenatal\" \"Both\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (PMH screening)\n",
    "##cleaning the data (if have both yes and no for pmh_screening  choose only yes)\n",
    "pmh1_true<-pmh_final%>%select(-c( PMH, PMH_problems, Depression, Anxiety,PMH_care,PMH_mangment, PMH_others ))%>%filter(PMH_screening==\"yes\")%>%distinct()\n",
    "pmh1_false<-pmh_final%>%select(-c( PMH, PMH_problems, Depression, Anxiety,PMH_care,PMH_mangment, PMH_others))%>%filter(PMH_screening==\"no\")%>%distinct()\n",
    "pmh1_false1<-anti_join(pmh1_false, pmh1_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh_s1<- bind_rows(pmh1_true,pmh1_false1)%>% distinct()  \n",
    "\n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh61<-pmh_s1%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide6=pmh61%>%spread(event_period, n)\n",
    " wide6$antenatal<-ifelse(is.na(wide6$antenatal), \"No\",\"Yes\")\n",
    "wide6$postnatal<-ifelse(is.na(wide6$postnatal), \"No\",\"Yes\")\n",
    "wide61<-wide6%>% mutate(Event_period_s= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_s)\n",
    "pmhs2<-pmh_s1%>%dplyr::select(-c(event_period, event_year))%>%distinct()\n",
    "pmhs2<-left_join(pmhs2, wide61)%>%distinct()\n",
    "str(pmhs2)\n",
    "write.csv(pmhs2,\"pmhs1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d3daa471-227e-4af6-b8ad-9f32db8fca33",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmhm%>% \n",
    "group_by( child_person_id) %>% \n",
    "summarise(n = n())%>%arrange(desc(n))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "id": "eb804b69-39e5-4f59-9a22-2dfbadbabdf8",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 7 × 15</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>person_id</th><th scope=col>child_person_id</th><th scope=col>mother_age</th><th scope=col>event_year</th><th scope=col>event_period</th><th scope=col>PMH</th><th scope=col>PMH_screening</th><th scope=col>PMH_problems</th><th scope=col>PMH_mangment</th><th scope=col>PMH_care</th><th scope=col>Depression</th><th scope=col>Anxiety</th><th scope=col>PMH_others</th><th scope=col>Family_history</th><th scope=col>pmh_medication</th></tr>\n",
       "\t<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>antenatal</td><td>yes</td><td>no</td><td>yes</td><td>yes</td><td>Care mild </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>antenatal</td><td>no </td><td>no</td><td>no </td><td>no </td><td>NA        </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>postnatal</td><td>no </td><td>no</td><td>no </td><td>no </td><td>NA        </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>postnatal</td><td>yes</td><td>no</td><td>yes</td><td>yes</td><td>Care sever</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>antenatal</td><td>yes</td><td>no</td><td>yes</td><td>yes</td><td>NA        </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2018</td><td>antenatal</td><td>no </td><td>no</td><td>no </td><td>no </td><td>NA        </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "\t<tr><td>13301034</td><td>1221311</td><td>21</td><td>2019</td><td>postnatal</td><td>yes</td><td>no</td><td>yes</td><td>yes</td><td>Care mild </td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 7 × 15\n",
       "\\begin{tabular}{lllllllllllllll}\n",
       " person\\_id & child\\_person\\_id & mother\\_age & event\\_year & event\\_period & PMH & PMH\\_screening & PMH\\_problems & PMH\\_mangment & PMH\\_care & Depression & Anxiety & PMH\\_others & Family\\_history & pmh\\_medication\\\\\n",
       " <int> & <int> & <int> & <int> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr>\\\\\n",
       "\\hline\n",
       "\t 13301034 & 1221311 & 21 & 2019 & antenatal & yes & no & yes & yes & Care mild  & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2019 & antenatal & no  & no & no  & no  & NA         & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2019 & postnatal & no  & no & no  & no  & NA         & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2019 & postnatal & yes & no & yes & yes & Care sever & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2019 & antenatal & yes & no & yes & yes & NA         & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2018 & antenatal & no  & no & no  & no  & NA         & no & no & no & no & no\\\\\n",
       "\t 13301034 & 1221311 & 21 & 2019 & postnatal & yes & no & yes & yes & Care mild  & no & no & no & no & no\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 7 × 15\n",
       "\n",
       "| person_id &lt;int&gt; | child_person_id &lt;int&gt; | mother_age &lt;int&gt; | event_year &lt;int&gt; | event_period &lt;chr&gt; | PMH &lt;chr&gt; | PMH_screening &lt;chr&gt; | PMH_problems &lt;chr&gt; | PMH_mangment &lt;chr&gt; | PMH_care &lt;chr&gt; | Depression &lt;chr&gt; | Anxiety &lt;chr&gt; | PMH_others &lt;chr&gt; | Family_history &lt;chr&gt; | pmh_medication &lt;chr&gt; |\n",
       "|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n",
       "| 13301034 | 1221311 | 21 | 2019 | antenatal | yes | no | yes | yes | Care mild  | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2019 | antenatal | no  | no | no  | no  | NA         | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2019 | postnatal | no  | no | no  | no  | NA         | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2019 | postnatal | yes | no | yes | yes | Care sever | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2019 | antenatal | yes | no | yes | yes | NA         | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2018 | antenatal | no  | no | no  | no  | NA         | no | no | no | no | no |\n",
       "| 13301034 | 1221311 | 21 | 2019 | postnatal | yes | no | yes | yes | Care mild  | no | no | no | no | no |\n",
       "\n"
      ],
      "text/plain": [
       "  person_id child_person_id mother_age event_year event_period PMH\n",
       "1 13301034  1221311         21         2019       antenatal    yes\n",
       "2 13301034  1221311         21         2019       antenatal    no \n",
       "3 13301034  1221311         21         2019       postnatal    no \n",
       "4 13301034  1221311         21         2019       postnatal    yes\n",
       "5 13301034  1221311         21         2019       antenatal    yes\n",
       "6 13301034  1221311         21         2018       antenatal    no \n",
       "7 13301034  1221311         21         2019       postnatal    yes\n",
       "  PMH_screening PMH_problems PMH_mangment PMH_care   Depression Anxiety\n",
       "1 no            yes          yes          Care mild  no         no     \n",
       "2 no            no           no           NA         no         no     \n",
       "3 no            no           no           NA         no         no     \n",
       "4 no            yes          yes          Care sever no         no     \n",
       "5 no            yes          yes          NA         no         no     \n",
       "6 no            no           no           NA         no         no     \n",
       "7 no            yes          yes          Care mild  no         no     \n",
       "  PMH_others Family_history pmh_medication\n",
       "1 no         no             no            \n",
       "2 no         no             no            \n",
       "3 no         no             no            \n",
       "4 no         no             no            \n",
       "5 no         no             no            \n",
       "6 no         no             no            \n",
       "7 no         no             no            "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh1%>%filter(child_person_id==1221311\n",
    "              )%>%View()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 73,
   "id": "e53c7e0d-0b69-4241-a116-bccb9b2f2cdf",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  894999 13591018 13288085 12623681 12747489 13018296 13257532 13741437 13700227 13087304 ...\n",
      " $ child_person_id                           : int  14991299 14991730 13638429 13441808 13311430 12625469 12542640 13189264 12751693 13104800 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2017 2016 2017 2017 2016 2016 2017 2017 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"Y\" \"N\" \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA \"yes\" \"no\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA 27.6 23.8 21.2 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Current smoker\" \"Current smoker\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" NA ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" NA \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ IMD                                       : chr  NA \"most deprived\" \"most deprived\" NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH_problems                              : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_p                            : chr  \"Both\" \"Postnatal\" \"Postnatal\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (PMH problems)\n",
    "##cleaning the data (if have both yes and no for pmh_problems  choose only yes)\n",
    "pmh1_true<-pmh_final%>%select(-c( PMH, PMH_screening, Depression, Anxiety,PMH_mangment,PMH_care, PMH_others))%>%filter(PMH_problems==\"yes\")%>%distinct()\n",
    "pmh1_false<-pmh_final%>%select(-c( PMH, PMH_screening, Depression, Anxiety,PMH_mangment, PMH_care, PMH_others))%>%filter(PMH_problems==\"no\")%>%distinct()\n",
    "pmh1_false1<-anti_join(pmh1_false, pmh1_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh5<- bind_rows(pmh1_true,pmh1_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh61<-pmh5%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide6=pmh61%>%spread(event_period, n)\n",
    " wide6$antenatal<-ifelse(is.na(wide6$antenatal), \"No\",\"Yes\")\n",
    "wide6$postnatal<-ifelse(is.na(wide6$postnatal), \"No\",\"Yes\")\n",
    "wide61<-wide6%>% mutate(Event_period_p= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_p)\n",
    "pmh62<-pmh5%>%dplyr::select(-c(event_period, event_year))%>%distinct()\n",
    "pmhp<-left_join(pmh62, wide61)%>%distinct()\n",
    "str(pmhp)\n",
    "write.csv(pmhp,\"pmhp1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "id": "2a2fa5f6-c5f7-4bf8-800a-0eb6b0c226fc",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  894999 13591018 13288085 12747489 13011878 13741437 13700227 13475319 12638693 12489793 ...\n",
      " $ child_person_id                           : int  14991299 14991730 13638429 13311430 13033559 13189264 12751693 12492168 13553319 12628811 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2017 2017 2017 2016 2017 2017 2017 2017 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" NA ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"Y\" \"N\" NA ...\n",
      " $ mental_health_prediction                  : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA \"yes\" \"no\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA 27.6 21.2 30.8 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Current smoker\" \"Ex-Smoker\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" NA \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  NA \"most deprived\" \"most deprived\" \"least deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ Depression                                : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_d                            : chr  \"Antenatal\" \"Postnatal\" \"Postnatal\" \"Antenatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (deprssion)\n",
    "##cleaning the data (if have both yes and no for pmh_problems  choose only yes)\n",
    "pmh2_true<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Anxiety,PMH_care,PMH_mangment, PMH_others, event_year))%>%filter(Depression==\"yes\")%>%distinct()\n",
    "pmh2_false<-pmh_final%>%select(-c(  PMH, PMH_screening, PMH_problems, Anxiety,PMH_care,PMH_mangment, PMH_others, event_year))%>%filter(Depression==\"no\")%>%distinct()\n",
    "pmh2_false1<-anti_join(pmh2_false, pmh2_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh6<- bind_rows(pmh2_true,pmh2_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh71<-pmh6%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide7=pmh71%>%spread(event_period, n)\n",
    " wide7$antenatal<-ifelse(is.na(wide7$antenatal), \"No\",\"Yes\")\n",
    "wide7$postnatal<-ifelse(is.na(wide7$postnatal), \"No\",\"Yes\")\n",
    "wide71<-wide7%>% mutate(Event_period_d= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_d)\n",
    "pmh72<-pmh6%>%dplyr::select(-c(event_period))%>%distinct()\n",
    "pmhd<-left_join(pmh72, wide71)%>%distinct()\n",
    "str(pmhd)\n",
    "write.csv(pmhd,\"pmhd1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "id": "8e76febe-1adc-42c8-8a0d-7016f5053531",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  894999 13591018 12747489 13257532 12821787 13027374 12678274 13603742 13364665 12491653 ...\n",
      " $ child_person_id                           : int  14991299 14991730 13311430 12542640 13668321 13633718 12500006 12535418 12565313 13474437 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2017 2016 2017 2017 2018 2016 2018 2017 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" NA \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"Y\" NA NA ...\n",
      " $ mental_health_prediction                  : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA \"yes\" \"no\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA 21.2 25.3 21.1 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Ex-Smoker\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" \"Yes\" NA ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ IMD                                       : chr  NA \"most deprived\" \"least deprived\" NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ Anxiety                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_a                            : chr  \"Antenatal\" \"Postnatal\" \"Antenatal\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (anxiety)\n",
    "##cleaning the data (if have both yes and no for pmh_problems  choose only yes)\n",
    "pmh3_true<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_care,PMH_mangment, PMH_others, event_year))%>%filter(Anxiety==\"yes\")%>%distinct()\n",
    "pmh3_false<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_care,PMH_mangment, PMH_others, event_year))%>%filter(Anxiety==\"no\")%>%distinct()\n",
    "pmh3_false1<-anti_join(pmh3_false, pmh3_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh7<- bind_rows(pmh3_true,pmh3_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh81<-pmh7%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide8=pmh81%>%spread(event_period, n)\n",
    " wide8$antenatal<-ifelse(is.na(wide8$antenatal), \"No\",\"Yes\")\n",
    "wide8$postnatal<-ifelse(is.na(wide8$postnatal), \"No\",\"Yes\")\n",
    "wide81<-wide8%>% mutate(Event_period_a= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_a)\n",
    "pmh82<-pmh7%>%dplyr::select(-c(event_period))%>%distinct()\n",
    "pmha<-left_join(pmh82, wide81)%>%distinct()\n",
    "str(pmha)\n",
    "write.csv(pmha,\"pmha1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 58,
   "id": "8bf79d86-d0e2-4799-bc86-c2b65cfa38df",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  13393456 13639172 12437298 12478405 12789089 12949414 11114492 12628720 12688543 13084729 ...\n",
      " $ child_person_id                           : int  14983070 14994354 13630608 13685246 12954029 13114196 14985975 13298822 13050535 14994279 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2017 2016 2017 2018 2022 2017 2017 2022 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" NA NA \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  \"N\" NA NA NA ...\n",
      " $ mental_health_prediction                  : chr  \"yes\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA \"no\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA 32.3 25.3 22.2 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" NA \"Ex-Smoker\" \"Never Smoked\" ...\n",
      " $ folic_acid                                : chr  \"taken prior to pregnancy\" \"start taking once pregnant\" NA \"taken prior to pregnancy\" ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" NA \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"yes\" \"no\" \"no\" ...\n",
      " $ IMD                                       : chr  NA NA \"most deprived\" \"most deprived\" ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH_others                                : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_o                            : chr  \"Postnatal\" \"Antenatal\" \"Postnatal\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (other PMH problems)\n",
    "##cleaning the data (if have both yes and no for pmh_problems  choose only yes)\n",
    "pmho_true<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_care,PMH_mangment, Anxiety, event_year))%>%filter(PMH_others==\"yes\")%>%distinct()\n",
    "pmho_false<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_care,PMH_mangment,Anxiety, event_year))%>%filter(PMH_others==\"no\")%>%distinct()\n",
    "pmho_false1<-anti_join(pmho_false, pmho_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh7o<- bind_rows(pmho_true,pmho_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh8o<-pmh7o%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide8o=pmh8o%>%spread(event_period, n)\n",
    " wide8o$antenatal<-ifelse(is.na(wide8o$antenatal), \"No\",\"Yes\")\n",
    "wide8o$postnatal<-ifelse(is.na(wide8o$postnatal), \"No\",\"Yes\")\n",
    "wide81o<-wide8o%>% mutate(Event_period_o= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_o)\n",
    "pmh82o<-pmh7o%>%dplyr::select(-c(event_period))%>%distinct()\n",
    "pmho<-left_join(pmh82o, wide81o)%>%distinct()\n",
    "str(pmho)\n",
    "write.csv(pmho,\"pmho1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 82,
   "id": "cb22310e-fc19-470c-863a-5f8ea7c9f88f",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t32186 obs. of  21 variables:\n",
      " $ person_id                                 : int  894999 13591018 13288085 12623681 12747489 13018296 13257532 13011878 13741437 13475319 ...\n",
      " $ child_person_id                           : int  14991299 14991730 13638429 13441808 13311430 12625469 12542640 13033559 13189264 12492168 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2017 2016 2017 2017 2016 2017 2016 2017 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA \"Y\" \"N\" \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA \"yes\" \"no\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA 27.6 23.8 21.2 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Current smoker\" \"Current smoker\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" NA ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" NA \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ IMD                                       : chr  NA \"most deprived\" \"most deprived\" NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH_mangment                              : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_m                            : chr  \"Both\" \"Postnatal\" \"Postnatal\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (Mangment of PMH problems)\n",
    "##cleaning the data (if have both yes and no for pmh_problems  choose only yes)\n",
    "pmhm_true<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_others,PMH_care, Anxiety, event_year))%>%filter(PMH_mangment==\"yes\")%>%distinct()\n",
    "pmhm_false<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_care,PMH_others,Anxiety, event_year))%>%filter(PMH_mangment==\"no\")%>%distinct()\n",
    "pmhm_false1<-anti_join(pmhm_false, pmhm_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh7m<- bind_rows(pmhm_true,pmhm_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh8m<-pmh7m%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide8m=pmh8m%>%spread(event_period, n)\n",
    " wide8m$antenatal<-ifelse(is.na(wide8m$antenatal), \"No\",\"Yes\")\n",
    "wide8m$postnatal<-ifelse(is.na(wide8m$postnatal), \"No\",\"Yes\")\n",
    "wide81m<-wide8m%>% mutate(Event_period_m= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_m)\n",
    "pmh82m<-pmh7m%>%dplyr::select(-c(event_period))%>%distinct()\n",
    "pmhm<-left_join(pmh82m, wide81m)%>%distinct()\n",
    "str(pmhm)\n",
    "write.csv(pmhm,\"pmhm1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 83,
   "id": "52daacb8-9bab-4625-96d0-a29ba395227b",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t33021 obs. of  22 variables:\n",
      " $ person_id                                 : int  894999 894999 13591018 12623681 12747489 12747489 13018296 13257532 13011878 13741437 ...\n",
      " $ child_person_id                           : int  14991299 14991299 14991730 13441808 13311430 13311430 12625469 12542640 13033559 13189264 ...\n",
      " $ baby_year_of_birth                        : int  2022 2022 2022 2016 2017 2017 2017 2016 2017 2016 ...\n",
      " $ Ethnicity                                 : chr  NA NA NA NA ...\n",
      " $ Employment                                : chr  \"Employed\" \"Employed\" \"Employed\" \"Employed\" ...\n",
      " $ support                                   : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ physical_disability_code_mother_at_booking: chr  NA NA \"Y\" \"N\" ...\n",
      " $ mental_health_prediction                  : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ complex_social_factors_indicator          : chr  NA NA \"yes\" \"no\" ...\n",
      " $ BMI                                       : num  NA NA NA 23.8 21.2 ...\n",
      " $ smoking                                   : chr  \"Never Smoked\" \"Never Smoked\" \"Never Smoked\" \"Current smoker\" ...\n",
      " $ folic_acid                                : chr  \"start taking once pregnant\" \"start taking once pregnant\" \"start taking once pregnant\" NA ...\n",
      " $ substance_abuse                           : chr  \"never\" \"never\" \"never\" \"never\" ...\n",
      " $ Speaks_English                            : chr  \"Yes\" \"Yes\" \"Yes\" \"Yes\" ...\n",
      " $ Interpreter_needed                        : chr  \"no\" \"no\" \"no\" \"yes\" ...\n",
      " $ IMD                                       : chr  NA NA \"most deprived\" NA ...\n",
      " $ mother_age                                : int  NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ PMH_mangment                              : chr  \"yes\" \"yes\" \"yes\" \"yes\" ...\n",
      " $ PMH_care                                  : chr  \"Care sever\" \"Care mild\" \"Care mild\" \"Care mild\" ...\n",
      " $ Family_history                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ pmh_medication                            : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ Event_period_c                            : chr  \"Antenatal\" \"Antenatal\" \"Postnatal\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##keeping only one record for each case (type of care for PMH problems)\n",
    "##cleaning the data (if have both yes and no for pmh_care  choose only yes)\n",
    "pmhc_true<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_others, Anxiety, event_year))%>%filter(PMH_care==\"Care sever\"| PMH_care==\"Care mild\")%>%distinct()\n",
    "pmhc_false<-pmh_final%>%select(-c( PMH, PMH_screening, PMH_problems, Depression,PMH_others,Anxiety, event_year))%>%filter(PMH_care==\"no\")%>%distinct()\n",
    "pmhc_false1<-anti_join(pmhc_false, pmhc_true, by=c(\"child_person_id\"))%>%distinct()\n",
    "pmh7c<- bind_rows(pmhc_true,pmhc_false1)%>% distinct()  \n",
    "##change the perinatal period to 3 periods\n",
    "\n",
    "pmh8c<-pmh7c%>%count(child_person_id, event_period,ssort=TRUE)\n",
    " wide8c=pmh8c%>%spread(event_period, n)\n",
    " wide8c$antenatal<-ifelse(is.na(wide8c$antenatal), \"No\",\"Yes\")\n",
    "wide8c$postnatal<-ifelse(is.na(wide8c$postnatal), \"No\",\"Yes\")\n",
    "wide81c<-wide8c%>% mutate(Event_period_c= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period_c)\n",
    "pmh82c<-pmh7c%>%dplyr::select(-c(event_period))%>%distinct()\n",
    "pmhc<-left_join(pmh82c, wide81c)%>%distinct()\n",
    "str(pmhc)\n",
    "write.csv(pmhc,\"pmhc1.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "id": "c881a93a-dfbc-471b-bebf-9dda3fcad9a0",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'data.frame':\t78572 obs. of  5 variables:\n",
      " $ child_person_id: int  14990929 14990929 14990929 14983170 14983170 14984291 14984291 14991299 14991299 14991299 ...\n",
      " $ person_id      : int  10702086 10702086 10702086 11114603 11114603 10764139 10764139 894999 894999 894999 ...\n",
      " $ PMH_mangment   : chr  \"no\" \"no\" \"no\" \"no\" ...\n",
      " $ PMH_care       : chr  NA NA NA NA ...\n",
      " $ event_period   : chr  NA \"antenatal\" \"postnatal\" \"postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "###Descriptive statistics \n",
    "##number of cases per baby year of birth\n",
    "pmh_care<- pmh_final%>% select (child_person_id, person_id, PMH_mangment, PMH_care, event_period)%>%distinct()\n",
    "  str(pmh_care)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "id": "fe3d9b1b-6770-4674-ae5c-09182582e6c9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 7 × 3</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>4079</td><td>12.68%</td></tr>\n",
       "\t<tr><td>2017</td><td>4957</td><td>15.41%</td></tr>\n",
       "\t<tr><td>2018</td><td>4767</td><td>14.82%</td></tr>\n",
       "\t<tr><td>2019</td><td>4767</td><td>14.82%</td></tr>\n",
       "\t<tr><td>2020</td><td>4544</td><td>14.13%</td></tr>\n",
       "\t<tr><td>2021</td><td>4599</td><td>14.30%</td></tr>\n",
       "\t<tr><td>2022</td><td>4456</td><td>13.85%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 7 × 3\n",
       "\\begin{tabular}{lll}\n",
       " baby\\_year\\_of\\_birth & count & percent\\\\\n",
       " <fct> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & 4079 & 12.68\\%\\\\\n",
       "\t 2017 & 4957 & 15.41\\%\\\\\n",
       "\t 2018 & 4767 & 14.82\\%\\\\\n",
       "\t 2019 & 4767 & 14.82\\%\\\\\n",
       "\t 2020 & 4544 & 14.13\\%\\\\\n",
       "\t 2021 & 4599 & 14.30\\%\\\\\n",
       "\t 2022 & 4456 & 13.85\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 7 × 3\n",
       "\n",
       "| baby_year_of_birth &lt;fct&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|\n",
       "| 2016 | 4079 | 12.68% |\n",
       "| 2017 | 4957 | 15.41% |\n",
       "| 2018 | 4767 | 14.82% |\n",
       "| 2019 | 4767 | 14.82% |\n",
       "| 2020 | 4544 | 14.13% |\n",
       "| 2021 | 4599 | 14.30% |\n",
       "| 2022 | 4456 | 13.85% |\n",
       "\n"
      ],
      "text/plain": [
       "  baby_year_of_birth count percent\n",
       "1 2016               4079  12.68% \n",
       "2 2017               4957  15.41% \n",
       "3 2018               4767  14.82% \n",
       "4 2019               4767  14.82% \n",
       "5 2020               4544  14.13% \n",
       "6 2021               4599  14.30% \n",
       "7 2022               4456  13.85% "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "###Descriptive statistics \n",
    "##number of cases per baby year of birth\n",
    "pmh4%>%\n",
    "  group_by( baby_year_of_birth) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "16ecf8cb-2b60-4814-8a8c-efe3eb41b5ee",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Descriptive statstics \n",
    "##mother age\n",
    "\n",
    "M1<-pmh4 %>% select(child_person_id, mother_age)%>%distinct()%>%\n",
    "  plot_frq(mother_age, type = \"histogram\", show.mean = TRUE, normal.curve = TRUE,  show.sd = TRUE,show.mean.val=TRUE , ylim = c(0,3000))\n",
    "save_plot(filename = \"mother_age.jpg\", fig = M1)\n",
    "\n",
    "summary(pmh4$mother_age)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3467afa7-c4a5-4903-b6d4-9781687cbe80",
   "metadata": {},
   "outputs": [],
   "source": [
    "##BMI\n",
    "bmi<-pmh4 %>% select(child_person_id, BMI)%>%distinct()%>%\n",
    "  plot_frq(BMI, type = \"histogram\", show.mean = TRUE, normal.curve = TRUE,  show.sd = TRUE,show.mean.val=TRUE )\n",
    "save_plot(filename = \"bmi.jpg\", fig = bmi)\n",
    "summary(pmh4$BMI)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cf744bd3-7d71-4db7-9b1a-6c53fc023a68",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Descriptive statstics \n",
    "##Ethnicithy\n",
    "##from the origin cohort (19 categories)\n",
    "##Ethnicithy in general  \n",
    "basic1 %>%  group_by(ethnicity_source_value) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))     \n",
    " \n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "dca9917a-a606-4f03-9882-5d8d9724049b",
   "metadata": {},
   "outputs": [],
   "source": [
    "###Ethnicithy with 3 categories only\n",
    "pmh4%>%\n",
    "  group_by(Ethnicity) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))\n",
    "ethnicithy<-pmh4%>%select(child_person_id, Ethnicity)%>%distinct()\n",
    "E1<-ethnicithy %>% \n",
    "  plot_frq(Ethnicity)\n",
    "save_plot(filename = \"E1.jpg\", fig = E1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "13fe1509-b7f5-439a-b006-14397c55cced",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Employment\n",
    "basic1 %>%  group_by(employment_status_mother_at_booking_desc ) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))     \n",
    " "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d3415eca-fd82-41ba-89e3-a3cd6b7db5f2",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Employment\n",
    "pmh4%>%\n",
    "  group_by(Employment ) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))\n",
    "employment1 <-pmh4%>%select(child_person_id, Employment )%>%distinct()\n",
    "Em1<-employment1  %>% \n",
    "  plot_frq(Employment )\n",
    "save_plot(filename = \"Em1.jpg\", fig = Em1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fc9cd43e-9e13-42a3-9efc-7bfe06d1e102",
   "metadata": {},
   "outputs": [],
   "source": [
    "##other demographic vararibles \n",
    "\n",
    "S1<-pmh4%>%  group_by( support) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))\n",
    "p1<-pmh4%>%  group_by( physical_disability_code_mother_at_booking) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "M1<-pmh4%>%  group_by( mental_health_prediction) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "C1<-pmh4%>%  group_by( complex_social_factors_indicator) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "eng1<-pmh4%>%  group_by(Speaks_English) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "int21<-pmh4%>%  group_by(Interpreter_needed) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "med1<-pmh4%>%  group_by(pmh_medication) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "fh1<-pmh4%>%  group_by(Family_history) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "\n",
    "fh1\n",
    "med1\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "64a76c7e-02d4-4e26-b5b8-6b02de411c8e",
   "metadata": {},
   "outputs": [],
   "source": [
    "str(pmh4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "da22a687-2452-4bb5-9604-b4f2cbf35fbc",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Other variables\n",
    "smoking<-pmh4%>%  group_by( smoking) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))\n",
    "folic_acid<-pmh4%>%  group_by( folic_acid) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n",
    "substance_abuse<-pmh4%>%  group_by( substance_abuse) %>%  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))  \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "59d9dac9-fc94-426d-a840-9584a633997e",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh4%>%\n",
    "  group_by( IMD) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "67d962af-1153-43e6-9767-0227ffa60de7",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'baby_year_of_birth'. You can override\n",
      "using the `.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 14 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>pmh</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>no </td><td> 717</td><td>18%</td></tr>\n",
       "\t<tr><td>2016</td><td>yes</td><td>3362</td><td>82%</td></tr>\n",
       "\t<tr><td>2017</td><td>no </td><td> 762</td><td>15%</td></tr>\n",
       "\t<tr><td>2017</td><td>yes</td><td>4195</td><td>85%</td></tr>\n",
       "\t<tr><td>2018</td><td>no </td><td> 564</td><td>12%</td></tr>\n",
       "\t<tr><td>2018</td><td>yes</td><td>4203</td><td>88%</td></tr>\n",
       "\t<tr><td>2019</td><td>no </td><td> 605</td><td>13%</td></tr>\n",
       "\t<tr><td>2019</td><td>yes</td><td>4162</td><td>87%</td></tr>\n",
       "\t<tr><td>2020</td><td>no </td><td> 469</td><td>10%</td></tr>\n",
       "\t<tr><td>2020</td><td>yes</td><td>4075</td><td>90%</td></tr>\n",
       "\t<tr><td>2021</td><td>no </td><td> 298</td><td>6% </td></tr>\n",
       "\t<tr><td>2021</td><td>yes</td><td>4301</td><td>94%</td></tr>\n",
       "\t<tr><td>2022</td><td>no </td><td> 228</td><td>5% </td></tr>\n",
       "\t<tr><td>2022</td><td>yes</td><td>4228</td><td>95%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 14 × 4\n",
       "\\begin{tabular}{llll}\n",
       " baby\\_year\\_of\\_birth & pmh & count & percent\\\\\n",
       " <int> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & no  &  717 & 18\\%\\\\\n",
       "\t 2016 & yes & 3362 & 82\\%\\\\\n",
       "\t 2017 & no  &  762 & 15\\%\\\\\n",
       "\t 2017 & yes & 4195 & 85\\%\\\\\n",
       "\t 2018 & no  &  564 & 12\\%\\\\\n",
       "\t 2018 & yes & 4203 & 88\\%\\\\\n",
       "\t 2019 & no  &  605 & 13\\%\\\\\n",
       "\t 2019 & yes & 4162 & 87\\%\\\\\n",
       "\t 2020 & no  &  469 & 10\\%\\\\\n",
       "\t 2020 & yes & 4075 & 90\\%\\\\\n",
       "\t 2021 & no  &  298 & 6\\% \\\\\n",
       "\t 2021 & yes & 4301 & 94\\%\\\\\n",
       "\t 2022 & no  &  228 & 5\\% \\\\\n",
       "\t 2022 & yes & 4228 & 95\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 14 × 4\n",
       "\n",
       "| baby_year_of_birth &lt;int&gt; | pmh &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| 2016 | no  |  717 | 18% |\n",
       "| 2016 | yes | 3362 | 82% |\n",
       "| 2017 | no  |  762 | 15% |\n",
       "| 2017 | yes | 4195 | 85% |\n",
       "| 2018 | no  |  564 | 12% |\n",
       "| 2018 | yes | 4203 | 88% |\n",
       "| 2019 | no  |  605 | 13% |\n",
       "| 2019 | yes | 4162 | 87% |\n",
       "| 2020 | no  |  469 | 10% |\n",
       "| 2020 | yes | 4075 | 90% |\n",
       "| 2021 | no  |  298 | 6%  |\n",
       "| 2021 | yes | 4301 | 94% |\n",
       "| 2022 | no  |  228 | 5%  |\n",
       "| 2022 | yes | 4228 | 95% |\n",
       "\n"
      ],
      "text/plain": [
       "   baby_year_of_birth pmh count percent\n",
       "1  2016               no   717  18%    \n",
       "2  2016               yes 3362  82%    \n",
       "3  2017               no   762  15%    \n",
       "4  2017               yes 4195  85%    \n",
       "5  2018               no   564  12%    \n",
       "6  2018               yes 4203  88%    \n",
       "7  2019               no   605  13%    \n",
       "8  2019               yes 4162  87%    \n",
       "9  2020               no   469  10%    \n",
       "10 2020               yes 4075  90%    \n",
       "11 2021               no   298  6%     \n",
       "12 2021               yes 4301  94%    \n",
       "13 2022               no   228  5%     \n",
       "14 2022               yes 4228  95%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##variables related to PMH\n",
    "##screening for PMH\n",
    "pmh4%>%  group_by( baby_year_of_birth,pmh) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f5e4789e-8010-4de3-9d87-fb0f2dfdc139",
   "metadata": {},
   "outputs": [],
   "source": [
    "##screening for PHM problems /visits\n",
    "pmh_final%>%  group_by( event_year,pmh) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0c047410-0570-4b04-be92-964d6096fa20",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh_visit<-pmh_final%>%  group_by( event_year,pmh) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na(pmh)%>%\n",
    "ggplot( aes(x=as.factor(event_year), y=count, fill=pmh)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=1.6, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ theme_classic()+xlab(\"YEAR\")\n",
    "save_plot(filename = \"pmh_visit.jpg\", fig = pmh_visit)\n",
    "\n",
    "pmh_visit1<-pmh_final%>%select(child_person_id, event_year, pmh)%>%distinct()\n",
    "\n",
    "plot1<-plot_xtab(\n",
    "  x   = pmh_final$event_year, \n",
    "  grp = pmh_final$pmh, \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"pmh_visit1.jpg\", fig = pmh_visit1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 58,
   "id": "77302570-7c42-48f6-9119-b90a5ba7e5ea",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'baby_year_of_birth'. You can override\n",
      "using the `.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 14 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>pmh_screening</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>no </td><td>1546</td><td>32%</td></tr>\n",
       "\t<tr><td>2016</td><td>yes</td><td>3283</td><td>68%</td></tr>\n",
       "\t<tr><td>2017</td><td>no </td><td>1772</td><td>30%</td></tr>\n",
       "\t<tr><td>2017</td><td>yes</td><td>4107</td><td>70%</td></tr>\n",
       "\t<tr><td>2018</td><td>no </td><td>1606</td><td>28%</td></tr>\n",
       "\t<tr><td>2018</td><td>yes</td><td>4117</td><td>72%</td></tr>\n",
       "\t<tr><td>2019</td><td>no </td><td>1628</td><td>28%</td></tr>\n",
       "\t<tr><td>2019</td><td>yes</td><td>4107</td><td>72%</td></tr>\n",
       "\t<tr><td>2020</td><td>no </td><td>1550</td><td>28%</td></tr>\n",
       "\t<tr><td>2020</td><td>yes</td><td>3996</td><td>72%</td></tr>\n",
       "\t<tr><td>2021</td><td>no </td><td>1566</td><td>27%</td></tr>\n",
       "\t<tr><td>2021</td><td>yes</td><td>4241</td><td>73%</td></tr>\n",
       "\t<tr><td>2022</td><td>no </td><td>1564</td><td>27%</td></tr>\n",
       "\t<tr><td>2022</td><td>yes</td><td>4204</td><td>73%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 14 × 4\n",
       "\\begin{tabular}{llll}\n",
       " baby\\_year\\_of\\_birth & pmh\\_screening & count & percent\\\\\n",
       " <fct> & <fct> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & no  & 1546 & 32\\%\\\\\n",
       "\t 2016 & yes & 3283 & 68\\%\\\\\n",
       "\t 2017 & no  & 1772 & 30\\%\\\\\n",
       "\t 2017 & yes & 4107 & 70\\%\\\\\n",
       "\t 2018 & no  & 1606 & 28\\%\\\\\n",
       "\t 2018 & yes & 4117 & 72\\%\\\\\n",
       "\t 2019 & no  & 1628 & 28\\%\\\\\n",
       "\t 2019 & yes & 4107 & 72\\%\\\\\n",
       "\t 2020 & no  & 1550 & 28\\%\\\\\n",
       "\t 2020 & yes & 3996 & 72\\%\\\\\n",
       "\t 2021 & no  & 1566 & 27\\%\\\\\n",
       "\t 2021 & yes & 4241 & 73\\%\\\\\n",
       "\t 2022 & no  & 1564 & 27\\%\\\\\n",
       "\t 2022 & yes & 4204 & 73\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 14 × 4\n",
       "\n",
       "| baby_year_of_birth &lt;fct&gt; | pmh_screening &lt;fct&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| 2016 | no  | 1546 | 32% |\n",
       "| 2016 | yes | 3283 | 68% |\n",
       "| 2017 | no  | 1772 | 30% |\n",
       "| 2017 | yes | 4107 | 70% |\n",
       "| 2018 | no  | 1606 | 28% |\n",
       "| 2018 | yes | 4117 | 72% |\n",
       "| 2019 | no  | 1628 | 28% |\n",
       "| 2019 | yes | 4107 | 72% |\n",
       "| 2020 | no  | 1550 | 28% |\n",
       "| 2020 | yes | 3996 | 72% |\n",
       "| 2021 | no  | 1566 | 27% |\n",
       "| 2021 | yes | 4241 | 73% |\n",
       "| 2022 | no  | 1564 | 27% |\n",
       "| 2022 | yes | 4204 | 73% |\n",
       "\n"
      ],
      "text/plain": [
       "   baby_year_of_birth pmh_screening count percent\n",
       "1  2016               no            1546  32%    \n",
       "2  2016               yes           3283  68%    \n",
       "3  2017               no            1772  30%    \n",
       "4  2017               yes           4107  70%    \n",
       "5  2018               no            1606  28%    \n",
       "6  2018               yes           4117  72%    \n",
       "7  2019               no            1628  28%    \n",
       "8  2019               yes           4107  72%    \n",
       "9  2020               no            1550  28%    \n",
       "10 2020               yes           3996  72%    \n",
       "11 2021               no            1566  27%    \n",
       "12 2021               yes           4241  73%    \n",
       "13 2022               no            1564  27%    \n",
       "14 2022               yes           4204  73%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh4%>%  group_by( baby_year_of_birth,pmh_screening) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "a2e43337-934c-4ee5-9259-6a1633cebcb9",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'event_period'. You can override using the\n",
      "`.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 4 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>event_period</th><th scope=col>depression</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>antenatal</td><td>no </td><td>12436</td><td>96%</td></tr>\n",
       "\t<tr><td>antenatal</td><td>yes</td><td>  573</td><td>4% </td></tr>\n",
       "\t<tr><td>postnatal</td><td>no </td><td>31361</td><td>93%</td></tr>\n",
       "\t<tr><td>postnatal</td><td>yes</td><td> 2505</td><td>7% </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 4 × 4\n",
       "\\begin{tabular}{llll}\n",
       " event\\_period & depression & count & percent\\\\\n",
       " <chr> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t antenatal & no  & 12436 & 96\\%\\\\\n",
       "\t antenatal & yes &   573 & 4\\% \\\\\n",
       "\t postnatal & no  & 31361 & 93\\%\\\\\n",
       "\t postnatal & yes &  2505 & 7\\% \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 4 × 4\n",
       "\n",
       "| event_period &lt;chr&gt; | depression &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| antenatal | no  | 12436 | 96% |\n",
       "| antenatal | yes |   573 | 4%  |\n",
       "| postnatal | no  | 31361 | 93% |\n",
       "| postnatal | yes |  2505 | 7%  |\n",
       "\n"
      ],
      "text/plain": [
       "  event_period depression count percent\n",
       "1 antenatal    no         12436 96%    \n",
       "2 antenatal    yes          573 4%     \n",
       "3 postnatal    no         31361 93%    \n",
       "4 postnatal    yes         2505 7%     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh4%>%  group_by( event_period,depression) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "99ce27d1-d241-46fe-9a76-7f6b05943d99",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'Event_period'. You can override using the\n",
      "`.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 6 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Event_period</th><th scope=col>pmh_problems</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>Antenatal</td><td>no </td><td>  486</td><td>76%</td></tr>\n",
       "\t<tr><td>Antenatal</td><td>yes</td><td>  154</td><td>24%</td></tr>\n",
       "\t<tr><td>Both     </td><td>no </td><td>11972</td><td>68%</td></tr>\n",
       "\t<tr><td>Both     </td><td>yes</td><td> 5525</td><td>32%</td></tr>\n",
       "\t<tr><td>Postnatal</td><td>no </td><td>19050</td><td>66%</td></tr>\n",
       "\t<tr><td>Postnatal</td><td>yes</td><td>10014</td><td>34%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 6 × 4\n",
       "\\begin{tabular}{llll}\n",
       " Event\\_period & pmh\\_problems & count & percent\\\\\n",
       " <chr> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t Antenatal & no  &   486 & 76\\%\\\\\n",
       "\t Antenatal & yes &   154 & 24\\%\\\\\n",
       "\t Both      & no  & 11972 & 68\\%\\\\\n",
       "\t Both      & yes &  5525 & 32\\%\\\\\n",
       "\t Postnatal & no  & 19050 & 66\\%\\\\\n",
       "\t Postnatal & yes & 10014 & 34\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 6 × 4\n",
       "\n",
       "| Event_period &lt;chr&gt; | pmh_problems &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| Antenatal | no  |   486 | 76% |\n",
       "| Antenatal | yes |   154 | 24% |\n",
       "| Both      | no  | 11972 | 68% |\n",
       "| Both      | yes |  5525 | 32% |\n",
       "| Postnatal | no  | 19050 | 66% |\n",
       "| Postnatal | yes | 10014 | 34% |\n",
       "\n"
      ],
      "text/plain": [
       "  Event_period pmh_problems count percent\n",
       "1 Antenatal    no             486 76%    \n",
       "2 Antenatal    yes            154 24%    \n",
       "3 Both         no           11972 68%    \n",
       "4 Both         yes           5525 32%    \n",
       "5 Postnatal    no           19050 66%    \n",
       "6 Postnatal    yes          10014 34%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh_d2%>%  group_by( Event_period,pmh_problems) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "id": "69dc6692-344b-4a92-aeb2-6d33dbe12328",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'baby_year_of_birth'. You can override\n",
      "using the `.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 14 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>pmh_problems</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>no </td><td>3249</td><td>80%</td></tr>\n",
       "\t<tr><td>2016</td><td>yes</td><td> 830</td><td>20%</td></tr>\n",
       "\t<tr><td>2017</td><td>no </td><td>3939</td><td>79%</td></tr>\n",
       "\t<tr><td>2017</td><td>yes</td><td>1018</td><td>21%</td></tr>\n",
       "\t<tr><td>2018</td><td>no </td><td>3720</td><td>78%</td></tr>\n",
       "\t<tr><td>2018</td><td>yes</td><td>1047</td><td>22%</td></tr>\n",
       "\t<tr><td>2019</td><td>no </td><td>3739</td><td>78%</td></tr>\n",
       "\t<tr><td>2019</td><td>yes</td><td>1028</td><td>22%</td></tr>\n",
       "\t<tr><td>2020</td><td>no </td><td>3463</td><td>76%</td></tr>\n",
       "\t<tr><td>2020</td><td>yes</td><td>1081</td><td>24%</td></tr>\n",
       "\t<tr><td>2021</td><td>no </td><td>3332</td><td>72%</td></tr>\n",
       "\t<tr><td>2021</td><td>yes</td><td>1267</td><td>28%</td></tr>\n",
       "\t<tr><td>2022</td><td>no </td><td>3116</td><td>70%</td></tr>\n",
       "\t<tr><td>2022</td><td>yes</td><td>1340</td><td>30%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 14 × 4\n",
       "\\begin{tabular}{llll}\n",
       " baby\\_year\\_of\\_birth & pmh\\_problems & count & percent\\\\\n",
       " <fct> & <fct> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & no  & 3249 & 80\\%\\\\\n",
       "\t 2016 & yes &  830 & 20\\%\\\\\n",
       "\t 2017 & no  & 3939 & 79\\%\\\\\n",
       "\t 2017 & yes & 1018 & 21\\%\\\\\n",
       "\t 2018 & no  & 3720 & 78\\%\\\\\n",
       "\t 2018 & yes & 1047 & 22\\%\\\\\n",
       "\t 2019 & no  & 3739 & 78\\%\\\\\n",
       "\t 2019 & yes & 1028 & 22\\%\\\\\n",
       "\t 2020 & no  & 3463 & 76\\%\\\\\n",
       "\t 2020 & yes & 1081 & 24\\%\\\\\n",
       "\t 2021 & no  & 3332 & 72\\%\\\\\n",
       "\t 2021 & yes & 1267 & 28\\%\\\\\n",
       "\t 2022 & no  & 3116 & 70\\%\\\\\n",
       "\t 2022 & yes & 1340 & 30\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 14 × 4\n",
       "\n",
       "| baby_year_of_birth &lt;fct&gt; | pmh_problems &lt;fct&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| 2016 | no  | 3249 | 80% |\n",
       "| 2016 | yes |  830 | 20% |\n",
       "| 2017 | no  | 3939 | 79% |\n",
       "| 2017 | yes | 1018 | 21% |\n",
       "| 2018 | no  | 3720 | 78% |\n",
       "| 2018 | yes | 1047 | 22% |\n",
       "| 2019 | no  | 3739 | 78% |\n",
       "| 2019 | yes | 1028 | 22% |\n",
       "| 2020 | no  | 3463 | 76% |\n",
       "| 2020 | yes | 1081 | 24% |\n",
       "| 2021 | no  | 3332 | 72% |\n",
       "| 2021 | yes | 1267 | 28% |\n",
       "| 2022 | no  | 3116 | 70% |\n",
       "| 2022 | yes | 1340 | 30% |\n",
       "\n"
      ],
      "text/plain": [
       "   baby_year_of_birth pmh_problems count percent\n",
       "1  2016               no           3249  80%    \n",
       "2  2016               yes           830  20%    \n",
       "3  2017               no           3939  79%    \n",
       "4  2017               yes          1018  21%    \n",
       "5  2018               no           3720  78%    \n",
       "6  2018               yes          1047  22%    \n",
       "7  2019               no           3739  78%    \n",
       "8  2019               yes          1028  22%    \n",
       "9  2020               no           3463  76%    \n",
       "10 2020               yes          1081  24%    \n",
       "11 2021               no           3332  72%    \n",
       "12 2021               yes          1267  28%    \n",
       "13 2022               no           3116  70%    \n",
       "14 2022               yes          1340  30%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh62%>%  group_by( baby_year_of_birth,pmh_problems) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "d73e334d-cb0b-49bc-8be8-400040c48b45",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'baby_year_of_birth'. You can override\n",
      "using the `.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 14 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>baby_year_of_birth</th><th scope=col>anxiety</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>2016</td><td>no </td><td>4073</td><td>92%</td></tr>\n",
       "\t<tr><td>2016</td><td>yes</td><td> 337</td><td>8% </td></tr>\n",
       "\t<tr><td>2017</td><td>no </td><td>4949</td><td>93%</td></tr>\n",
       "\t<tr><td>2017</td><td>yes</td><td> 377</td><td>7% </td></tr>\n",
       "\t<tr><td>2018</td><td>no </td><td>4759</td><td>92%</td></tr>\n",
       "\t<tr><td>2018</td><td>yes</td><td> 400</td><td>8% </td></tr>\n",
       "\t<tr><td>2019</td><td>no </td><td>4755</td><td>93%</td></tr>\n",
       "\t<tr><td>2019</td><td>yes</td><td> 375</td><td>7% </td></tr>\n",
       "\t<tr><td>2020</td><td>no </td><td>4538</td><td>84%</td></tr>\n",
       "\t<tr><td>2020</td><td>yes</td><td> 889</td><td>16%</td></tr>\n",
       "\t<tr><td>2021</td><td>no </td><td>4596</td><td>71%</td></tr>\n",
       "\t<tr><td>2021</td><td>yes</td><td>1906</td><td>29%</td></tr>\n",
       "\t<tr><td>2022</td><td>no </td><td>4453</td><td>65%</td></tr>\n",
       "\t<tr><td>2022</td><td>yes</td><td>2393</td><td>35%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 14 × 4\n",
       "\\begin{tabular}{llll}\n",
       " baby\\_year\\_of\\_birth & anxiety & count & percent\\\\\n",
       " <int> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t 2016 & no  & 4073 & 92\\%\\\\\n",
       "\t 2016 & yes &  337 & 8\\% \\\\\n",
       "\t 2017 & no  & 4949 & 93\\%\\\\\n",
       "\t 2017 & yes &  377 & 7\\% \\\\\n",
       "\t 2018 & no  & 4759 & 92\\%\\\\\n",
       "\t 2018 & yes &  400 & 8\\% \\\\\n",
       "\t 2019 & no  & 4755 & 93\\%\\\\\n",
       "\t 2019 & yes &  375 & 7\\% \\\\\n",
       "\t 2020 & no  & 4538 & 84\\%\\\\\n",
       "\t 2020 & yes &  889 & 16\\%\\\\\n",
       "\t 2021 & no  & 4596 & 71\\%\\\\\n",
       "\t 2021 & yes & 1906 & 29\\%\\\\\n",
       "\t 2022 & no  & 4453 & 65\\%\\\\\n",
       "\t 2022 & yes & 2393 & 35\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 14 × 4\n",
       "\n",
       "| baby_year_of_birth &lt;int&gt; | anxiety &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| 2016 | no  | 4073 | 92% |\n",
       "| 2016 | yes |  337 | 8%  |\n",
       "| 2017 | no  | 4949 | 93% |\n",
       "| 2017 | yes |  377 | 7%  |\n",
       "| 2018 | no  | 4759 | 92% |\n",
       "| 2018 | yes |  400 | 8%  |\n",
       "| 2019 | no  | 4755 | 93% |\n",
       "| 2019 | yes |  375 | 7%  |\n",
       "| 2020 | no  | 4538 | 84% |\n",
       "| 2020 | yes |  889 | 16% |\n",
       "| 2021 | no  | 4596 | 71% |\n",
       "| 2021 | yes | 1906 | 29% |\n",
       "| 2022 | no  | 4453 | 65% |\n",
       "| 2022 | yes | 2393 | 35% |\n",
       "\n"
      ],
      "text/plain": [
       "   baby_year_of_birth anxiety count percent\n",
       "1  2016               no      4073  92%    \n",
       "2  2016               yes      337  8%     \n",
       "3  2017               no      4949  93%    \n",
       "4  2017               yes      377  7%     \n",
       "5  2018               no      4759  92%    \n",
       "6  2018               yes      400  8%     \n",
       "7  2019               no      4755  93%    \n",
       "8  2019               yes      375  7%     \n",
       "9  2020               no      4538  84%    \n",
       "10 2020               yes      889  16%    \n",
       "11 2021               no      4596  71%    \n",
       "12 2021               yes     1906  29%    \n",
       "13 2022               no      4453  65%    \n",
       "14 2022               yes     2393  35%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh4%>%  group_by( baby_year_of_birth,anxiety ) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "2fad2c07-23cf-4c34-8ed1-018ed2e6aaff",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'event_period'. You can override using the\n",
      "`.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 4 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>event_period</th><th scope=col>anxiety</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>antenatal</td><td>no </td><td>12494</td><td>93%</td></tr>\n",
       "\t<tr><td>antenatal</td><td>yes</td><td>  964</td><td>7% </td></tr>\n",
       "\t<tr><td>postnatal</td><td>no </td><td>31538</td><td>84%</td></tr>\n",
       "\t<tr><td>postnatal</td><td>yes</td><td> 6172</td><td>16%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 4 × 4\n",
       "\\begin{tabular}{llll}\n",
       " event\\_period & anxiety & count & percent\\\\\n",
       " <chr> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t antenatal & no  & 12494 & 93\\%\\\\\n",
       "\t antenatal & yes &   964 & 7\\% \\\\\n",
       "\t postnatal & no  & 31538 & 84\\%\\\\\n",
       "\t postnatal & yes &  6172 & 16\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 4 × 4\n",
       "\n",
       "| event_period &lt;chr&gt; | anxiety &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| antenatal | no  | 12494 | 93% |\n",
       "| antenatal | yes |   964 | 7%  |\n",
       "| postnatal | no  | 31538 | 84% |\n",
       "| postnatal | yes |  6172 | 16% |\n",
       "\n"
      ],
      "text/plain": [
       "  event_period anxiety count percent\n",
       "1 antenatal    no      12494 93%    \n",
       "2 antenatal    yes       964 7%     \n",
       "3 postnatal    no      31538 84%    \n",
       "4 postnatal    yes      6172 16%    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh4%>%  group_by( event_period,anxiety ) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "68dd5b2f-181d-401f-9eef-2b164f61ea41",
   "metadata": {},
   "outputs": [],
   "source": [
    "##screening of PMH per patieint (pregnancy)\n",
    "pmh<-pmh4%>%  group_by( baby_year_of_birth,pmh) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na(pmh)%>%\n",
    "ggplot( aes(x=as.factor(baby_year_of_birth), y=count, fill=pmh)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=1.6, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ theme_classic()+xlab(\"YEAR\")\n",
    "save_plot(filename = \"pmh.jpg\", fig = pmh)\n",
    "\n",
    "pmh4a<-pmh4%>%select(child_person_id, baby_year_of_birth, pmh)%>%distinct()\n",
    "\n",
    "plot1<-plot_xtab(\n",
    "  x   = pmh4a$baby_year_of_birth, \n",
    "  grp = pmh4a$pmh, \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"plot11.jpg\", fig = plot1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2a2a57f3-9bde-48bb-9fe7-e546896b5ef0",
   "metadata": {},
   "outputs": [],
   "source": [
    "########################################################## Factors afectiong the PMH screening ##########"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "92ecaab8-7a47-4719-b32e-caf2b6fa7756",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "72a73320-31da-43b2-8030-b89bc9f4ed66",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh52 %>% \n",
    "group_by(child_person_id) %>% \n",
    "summarise(n = n())%>%arrange(desc(n))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 107,
   "id": "98b7aeba-807e-4e51-b54e-ef73017993b6",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'pmh_problems'. You can override using the\n",
      "`.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 6 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>pmh_problems</th><th scope=col>Event_period</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>Antenatal</td><td>  426</td><td>2.6% </td></tr>\n",
       "\t<tr><td>no </td><td>Both     </td><td> 6525</td><td>39.6%</td></tr>\n",
       "\t<tr><td>no </td><td>Postnatal</td><td> 9514</td><td>57.8%</td></tr>\n",
       "\t<tr><td>yes</td><td>Antenatal</td><td>  870</td><td>5.5% </td></tr>\n",
       "\t<tr><td>yes</td><td>Both     </td><td> 2320</td><td>14.8%</td></tr>\n",
       "\t<tr><td>yes</td><td>Postnatal</td><td>12492</td><td>79.6%</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 6 × 4\n",
       "\\begin{tabular}{llll}\n",
       " pmh\\_problems & Event\\_period & count & percent\\\\\n",
       " <chr> & <chr> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & Antenatal &   426 & 2.6\\% \\\\\n",
       "\t no  & Both      &  6525 & 39.6\\%\\\\\n",
       "\t no  & Postnatal &  9514 & 57.8\\%\\\\\n",
       "\t yes & Antenatal &   870 & 5.5\\% \\\\\n",
       "\t yes & Both      &  2320 & 14.8\\%\\\\\n",
       "\t yes & Postnatal & 12492 & 79.6\\%\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 6 × 4\n",
       "\n",
       "| pmh_problems &lt;chr&gt; | Event_period &lt;chr&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| no  | Antenatal |   426 | 2.6%  |\n",
       "| no  | Both      |  6525 | 39.6% |\n",
       "| no  | Postnatal |  9514 | 57.8% |\n",
       "| yes | Antenatal |   870 | 5.5%  |\n",
       "| yes | Both      |  2320 | 14.8% |\n",
       "| yes | Postnatal | 12492 | 79.6% |\n",
       "\n"
      ],
      "text/plain": [
       "  pmh_problems Event_period count percent\n",
       "1 no           Antenatal      426 2.6%   \n",
       "2 no           Both          6525 39.6%  \n",
       "3 no           Postnatal     9514 57.8%  \n",
       "4 yes          Antenatal      870 5.5%   \n",
       "5 yes          Both          2320 14.8%  \n",
       "6 yes          Postnatal    12492 79.6%  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh62%>%  group_by(pmh_problems,Event_period) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 155,
   "id": "cfb07121-45a5-404f-ab9d-f7bb78089d64",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh_period<-pmh52%>%filter( pmh==\"yes\")%>%select(child_person_id, Event_period)%>%distinct()\n",
    "period11<-pmh_period  %>% \n",
    "  plot_frq(Event_period )\n",
    "save_plot(filename = \"period11.jpg\", fig = period11)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4e935d35-7202-45c1-8aaf-9382549698b3",
   "metadata": {},
   "outputs": [],
   "source": [
    "##1 perinatal period\n",
    "pmh_period<-pmh52%>%filter( pmh==\"yes\")%>%select(child_person_id, Event_period)%>%distinct()\n",
    "period1<-plot_xtab(\n",
    "  x   = pmh_period$Event_period, \n",
    "  grp = pmh_period$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)+xlab(\"Perinatl Period\")\n",
    "save_plot(filename = \"period1.jpg\", fig = period1)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "45dabb3c-4b36-4682-8cbc-7b088288451d",
   "metadata": {},
   "outputs": [],
   "source": [
    "### maternal age\n",
    "pmh_maternal<-pmh52%>%select(child_person_id, mother_age, pmh)%>%distinct()\n",
    "g <- ggplot(pmh_maternal, aes(pmh,mother_age)) + geom_boxplot() + \n",
    "    labs(x=\"PMH screening\",\n",
    "         y=\"Maternal age\")+ stat_summary(fun.y=mean, geom=\"point\", shape=23, size=6)\n",
    "\n",
    "save_plot(filename = \"maternal.jpg\", fig = g)\n",
    "t.test(mother_age ~pmh, data = pmh_maternal)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b1f1bce6-e680-4d8f-815d-bb32288fec55",
   "metadata": {},
   "outputs": [],
   "source": [
    "### bmi\n",
    "pmh_bmi<-pmh52%>%select(child_person_id, BMI, pmh)%>%distinct()\n",
    "bmi <- ggplot(pmh_bmi, aes(pmh,BMI)) + geom_boxplot() + \n",
    "    labs(x=\"PMH screening\",\n",
    "         y=\"BMI\")+ stat_summary(fun.y=mean, geom=\"point\", shape=23, size=6)\n",
    "\n",
    "save_plot(filename = \"bmi.jpg\", fig = bmi)\n",
    "t.test(BMI ~pmh, data = pmh_bmi)\n",
    "wilcox.test(BMI ~pmh, data = pmh_bmi)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "83fdb3ed-832e-4604-a62a-91b8059cb360",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Ethnicithy \n",
    "pmh_eth<-pmh52%>%select(child_person_id, Ethnicity, pmh)%>%distinct()\n",
    "Eth<-plot_xtab(\n",
    "  x   = pmh_eth$Ethnicity, \n",
    "  grp = pmh_eth$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE,\n",
    "show.n = TRUE,)\n",
    "save_plot(filename = \"Eth.jpg\", fig = Eth)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "76b652e6-10f2-48f2-800e-5a6d8960cda5",
   "metadata": {},
   "outputs": [],
   "source": [
    "ethincity<-pmh52%>%  group_by(Ethnicity,pmh) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%\n",
    "ggplot( aes(x=as.factor(Ethnicity), y=count, fill=pmh)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=-0.2, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ \n",
    "  theme(axis.text = element_text( \n",
    "    angle = 90,    color=\"black\",    size=10,     face=2)\n",
    "  )+xlab(\"Ethnicity\")\n",
    "save_plot(filename = \"ethincity.jpg\", fig =ethincity)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7d0ac295-b1cb-420a-9298-c05948c217c1",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Employment \n",
    "pmh_emp<-pmh52%>%select(child_person_id, Employment, pmh)%>%distinct()\n",
    "Emp<-plot_xtab(\n",
    "  x   = pmh_emp$Employment, \n",
    "  grp = pmh_emp$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"Emp.jpg\", fig = Emp)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b4f8e183-1b0f-4150-9830-2f0abc22fcb9",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Speaking English\n",
    "pmh_spe<-pmh4%>%select(child_person_id, Speaks_English, pmh)%>%distinct()\n",
    "spe<-plot_xtab(\n",
    "  x   = pmh_spe$Speaks_English, \n",
    "  grp = pmh_spe$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"spe.jpg\", fig = spe)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1ef4af24-fbdc-4958-9d68-b3397f492a64",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Interperter needed\n",
    "pmh_int<-pmh52%>%select(child_person_id, Interpreter_needed, pmh)%>%distinct()\n",
    "int<-plot_xtab(\n",
    "  x   = pmh_int$Interpreter_needed, \n",
    "  grp = pmh_int$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"int.jpg\", fig = int)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "316dabc9-8042-4628-a555-0aa33a3635c3",
   "metadata": {},
   "outputs": [],
   "source": [
    "#medication \n",
    "pmh_med<-pmh52%>%select(child_person_id, pmh_medication, pmh)%>%distinct()\n",
    "med<-plot_xtab(\n",
    "  x   = pmh_med$pmh_medication, \n",
    "  grp = pmh_med$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"med.jpg\", fig = med)\n",
    "\n",
    "#family history \n",
    "pmh_fh<-pmh52%>%select(child_person_id, Family_history, pmh)%>%distinct()\n",
    "fh<-plot_xtab(\n",
    "  x   = pmh_fh$Family_history, \n",
    "  grp = pmh_fh$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"fh.jpg\", fig = fh)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b9a535aa-4702-4acf-ab61-413ad1e1a4c4",
   "metadata": {},
   "outputs": [],
   "source": [
    "##IMD\n",
    "pmh_IMD<-pmh52%>%select(child_person_id, IMD, pmh)%>%distinct()\n",
    "IMD<-plot_xtab(\n",
    "  x   = pmh_IMD$IMD, \n",
    "  grp = pmh_IMD$pmh , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"IMD.jpg\", fig = IMD)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2e710a76-6795-46ae-bc7f-4d154ecbfba0",
   "metadata": {},
   "outputs": [],
   "source": [
    "####Regression analysis for PMH screening####"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "176ddf36-c9eb-466b-b413-838526c3bd39",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n",
      "Attaching package: ‘MASS’\n",
      "\n",
      "\n",
      "The following object is masked from ‘package:dplyr’:\n",
      "\n",
      "    select\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "library(MASS)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 127,
   "id": "fbaf18f8-6704-4fe1-89c2-f2eb5c862256",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [32,169 × 21] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                 : int [1:32169] 8448253 12655334 13424191 13542759 1040492 13122567 12647542 13371312 10647060 12905236 ...\n",
      " $ child_person_id                           : int [1:32169] 14993025 12601918 13185264 14989821 14992132 14993653 14990982 14992050 14994326 13071420 ...\n",
      " $ baby_year_of_birth                        : Factor w/ 7 levels \"2016\",\"2017\",..: 7 1 2 7 7 7 7 7 7 1 ...\n",
      " $ Ethnicity                                 : Factor w/ 3 levels \"Asian Pakistani\",..: NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ Employment                                : Factor w/ 4 levels \"Employed\",\"Homemaker not looking for work\",..: 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ support                                   : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ physical_disability_code_mother_at_booking: Factor w/ 2 levels \"N\",\"Y\": 1 1 1 NA 1 1 1 1 1 1 ...\n",
      " $ mental_health_prediction                  : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ complex_social_factors_indicator          : Factor w/ 2 levels \"no\",\"yes\": 2 NA NA NA NA 2 NA NA NA 2 ...\n",
      " $ BMI                                       : num [1:32169] NA 32 18.6 33.5 NA ...\n",
      " $ smoking                                   : Factor w/ 3 levels \"Current smoker\",..: NA 3 3 3 3 3 3 3 3 3 ...\n",
      " $ folic_acid                                : Factor w/ 3 levels \"not taken\",\"start taking once pregnant\",..: 2 3 2 2 2 2 2 2 2 2 ...\n",
      " $ substance_abuse                           : Factor w/ 3 levels \"currently using\",..: 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Speaks_English                            : Factor w/ 2 levels \"No\",\"Yes\": 2 2 NA NA 2 2 2 NA 2 2 ...\n",
      " $ IMD                                       : Factor w/ 3 levels \"least deprived\",..: 2 NA NA NA NA 3 3 NA 2 3 ...\n",
      " $ Interpreter_needed                        : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 2 1 1 1 ...\n",
      " $ mother_age                                : int [1:32169] NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ pmh                                       : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Family_history                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ pmh_medication                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ Event_period                              : chr [1:32169] \"Postnatal\" \"Postnatal\" \"Both\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh52)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "id": "363b495a-13d1-480f-9976-e739b2b144c6",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "pmh52$Ethnicity <- relevel(pmh52$Ethnicity, \"White British\")\n",
    "pmh52$pmh <- relevel(pmh52$pmh, \"no\")\n",
    "pmh52$IMD <- relevel(pmh52$IMD, \"most deprived\")\n",
    "pmh52$Employment<- relevel(pmh52$Employment, \"Employed\")\n",
    "pmh52$Interpreter_needed <- relevel(pmh52$Interpreter_needed, \"no\")\n",
    "pmh52$Event_period <- as.factor(pmh52$Event_period) \n",
    "pmh52$Event_period <- relevel(pmh52$Event_period, \"Both\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "id": "94742c1c-7900-4196-8003-7cfd07f48e50",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'pmh'. You can override using the `.groups`\n",
      "argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 8 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>pmh</th><th scope=col>Event_period</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>Both     </td><td> 3107</td><td>85.29%</td></tr>\n",
       "\t<tr><td>no </td><td>Antenatal</td><td>  281</td><td>7.71% </td></tr>\n",
       "\t<tr><td>no </td><td>Postnatal</td><td>  253</td><td>6.94% </td></tr>\n",
       "\t<tr><td>no </td><td>NA       </td><td>    2</td><td>0.05% </td></tr>\n",
       "\t<tr><td>yes</td><td>Both     </td><td> 8943</td><td>31.4% </td></tr>\n",
       "\t<tr><td>yes</td><td>Antenatal</td><td>  299</td><td>1.0%  </td></tr>\n",
       "\t<tr><td>yes</td><td>Postnatal</td><td>19275</td><td>67.6% </td></tr>\n",
       "\t<tr><td>yes</td><td>NA       </td><td>    9</td><td>0.0%  </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 8 × 4\n",
       "\\begin{tabular}{llll}\n",
       " pmh & Event\\_period & count & percent\\\\\n",
       " <fct> & <fct> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & Both      &  3107 & 85.29\\%\\\\\n",
       "\t no  & Antenatal &   281 & 7.71\\% \\\\\n",
       "\t no  & Postnatal &   253 & 6.94\\% \\\\\n",
       "\t no  & NA        &     2 & 0.05\\% \\\\\n",
       "\t yes & Both      &  8943 & 31.4\\% \\\\\n",
       "\t yes & Antenatal &   299 & 1.0\\%  \\\\\n",
       "\t yes & Postnatal & 19275 & 67.6\\% \\\\\n",
       "\t yes & NA        &     9 & 0.0\\%  \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 8 × 4\n",
       "\n",
       "| pmh &lt;fct&gt; | Event_period &lt;fct&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| no  | Both      |  3107 | 85.29% |\n",
       "| no  | Antenatal |   281 | 7.71%  |\n",
       "| no  | Postnatal |   253 | 6.94%  |\n",
       "| no  | NA        |     2 | 0.05%  |\n",
       "| yes | Both      |  8943 | 31.4%  |\n",
       "| yes | Antenatal |   299 | 1.0%   |\n",
       "| yes | Postnatal | 19275 | 67.6%  |\n",
       "| yes | NA        |     9 | 0.0%   |\n",
       "\n"
      ],
      "text/plain": [
       "  pmh Event_period count percent\n",
       "1 no  Both          3107 85.29% \n",
       "2 no  Antenatal      281 7.71%  \n",
       "3 no  Postnatal      253 6.94%  \n",
       "4 no  NA               2 0.05%  \n",
       "5 yes Both          8943 31.4%  \n",
       "6 yes Antenatal      299 1.0%   \n",
       "7 yes Postnatal    19275 67.6%  \n",
       "8 yes NA               9 0.0%   "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh52%>%  group_by(pmh,Event_period) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "id": "34b78e18-ed10-498c-b08d-44291bcf0084",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A matrix: 3 × 2 of type dbl</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>Asian Pakistani</th><th scope=col>Others</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>White British</th><td>0</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>Asian Pakistani</th><td>1</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>Others</th><td>0</td><td>1</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A matrix: 3 × 2 of type dbl\n",
       "\\begin{tabular}{r|ll}\n",
       "  & Asian Pakistani & Others\\\\\n",
       "\\hline\n",
       "\tWhite British & 0 & 0\\\\\n",
       "\tAsian Pakistani & 1 & 0\\\\\n",
       "\tOthers & 0 & 1\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A matrix: 3 × 2 of type dbl\n",
       "\n",
       "| <!--/--> | Asian Pakistani | Others |\n",
       "|---|---|---|\n",
       "| White British | 0 | 0 |\n",
       "| Asian Pakistani | 1 | 0 |\n",
       "| Others | 0 | 1 |\n",
       "\n"
      ],
      "text/plain": [
       "                Asian Pakistani Others\n",
       "White British   0               0     \n",
       "Asian Pakistani 1               0     \n",
       "Others          0               1     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A matrix: 3 × 2 of type dbl</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>least deprived</th><th scope=col>moderate deprived</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>most deprived</th><td>0</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>least deprived</th><td>1</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>moderate deprived</th><td>0</td><td>1</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A matrix: 3 × 2 of type dbl\n",
       "\\begin{tabular}{r|ll}\n",
       "  & least deprived & moderate deprived\\\\\n",
       "\\hline\n",
       "\tmost deprived & 0 & 0\\\\\n",
       "\tleast deprived & 1 & 0\\\\\n",
       "\tmoderate deprived & 0 & 1\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A matrix: 3 × 2 of type dbl\n",
       "\n",
       "| <!--/--> | least deprived | moderate deprived |\n",
       "|---|---|---|\n",
       "| most deprived | 0 | 0 |\n",
       "| least deprived | 1 | 0 |\n",
       "| moderate deprived | 0 | 1 |\n",
       "\n"
      ],
      "text/plain": [
       "                  least deprived moderate deprived\n",
       "most deprived     0              0                \n",
       "least deprived    1              0                \n",
       "moderate deprived 0              1                "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A matrix: 4 × 3 of type dbl</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>Homemaker not looking for work</th><th scope=col>others</th><th scope=col>Unemployed and seeking work</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>Employed</th><td>0</td><td>0</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>Homemaker not looking for work</th><td>1</td><td>0</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>others</th><td>0</td><td>1</td><td>0</td></tr>\n",
       "\t<tr><th scope=row>Unemployed and seeking work</th><td>0</td><td>0</td><td>1</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A matrix: 4 × 3 of type dbl\n",
       "\\begin{tabular}{r|lll}\n",
       "  & Homemaker not looking for work & others & Unemployed and seeking work\\\\\n",
       "\\hline\n",
       "\tEmployed & 0 & 0 & 0\\\\\n",
       "\tHomemaker not looking for work & 1 & 0 & 0\\\\\n",
       "\tothers & 0 & 1 & 0\\\\\n",
       "\tUnemployed and seeking work & 0 & 0 & 1\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A matrix: 4 × 3 of type dbl\n",
       "\n",
       "| <!--/--> | Homemaker not looking for work | others | Unemployed and seeking work |\n",
       "|---|---|---|---|\n",
       "| Employed | 0 | 0 | 0 |\n",
       "| Homemaker not looking for work | 1 | 0 | 0 |\n",
       "| others | 0 | 1 | 0 |\n",
       "| Unemployed and seeking work | 0 | 0 | 1 |\n",
       "\n"
      ],
      "text/plain": [
       "                               Homemaker not looking for work others\n",
       "Employed                       0                              0     \n",
       "Homemaker not looking for work 1                              0     \n",
       "others                         0                              1     \n",
       "Unemployed and seeking work    0                              0     \n",
       "                               Unemployed and seeking work\n",
       "Employed                       0                          \n",
       "Homemaker not looking for work 0                          \n",
       "others                         0                          \n",
       "Unemployed and seeking work    1                          "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "contrasts(pmh52$Ethnicity)\n",
    "contrasts(pmh52$IMD)\n",
    "contrasts(pmh52$Employment)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "id": "44a39cfb-9439-4eca-b5e6-54283b336c53",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh ~ ., family = binomial, data = pmh53)\n",
       "\n",
       "Deviance Residuals: \n",
       "    Min       1Q   Median       3Q      Max  \n",
       "-3.4083   0.1128   0.1476   0.5290   1.2999  \n",
       "\n",
       "Coefficients:\n",
       "                                          Estimate Std. Error z value Pr(>|z|)\n",
       "(Intercept)                               1.397759   0.310200   4.506 6.61e-06\n",
       "EthnicityAsian Pakistani                  0.205918   0.104657   1.968 0.049119\n",
       "EthnicityOthers                          -0.071880   0.111638  -0.644 0.519660\n",
       "EmploymentHomemaker not looking for work  0.182483   0.084791   2.152 0.031385\n",
       "Employmentothers                          0.492293   0.284336   1.731 0.083384\n",
       "EmploymentUnemployed and seeking work     0.529607   0.153774   3.444 0.000573\n",
       "IMDleast deprived                        -0.161978   0.196479  -0.824 0.409712\n",
       "IMDmoderate deprived                      0.040908   0.150666   0.272 0.785993\n",
       "Event_periodPostnatal                     3.571568   0.138644  25.761  < 2e-16\n",
       "mother_age                               -0.044389   0.007389  -6.007 1.89e-09\n",
       "BMI                                      -0.006100   0.006403  -0.953 0.340763\n",
       "baby_year_of_birth2017                    0.352384   0.174323   2.021 0.043234\n",
       "baby_year_of_birth2018                    0.927277   0.157031   5.905 3.53e-09\n",
       "baby_year_of_birth2019                    0.799869   0.153386   5.215 1.84e-07\n",
       "baby_year_of_birth2020                    0.850106   0.157101   5.411 6.26e-08\n",
       "baby_year_of_birth2021                    1.246022   0.173706   7.173 7.33e-13\n",
       "baby_year_of_birth2022                    2.029289   0.250608   8.097 5.61e-16\n",
       "complex_social_factors_indicatoryes       0.314939   0.172129   1.830 0.067300\n",
       "Speaks_EnglishYes                         0.081986   0.109936   0.746 0.455815\n",
       "                                            \n",
       "(Intercept)                              ***\n",
       "EthnicityAsian Pakistani                 *  \n",
       "EthnicityOthers                             \n",
       "EmploymentHomemaker not looking for work *  \n",
       "Employmentothers                         .  \n",
       "EmploymentUnemployed and seeking work    ***\n",
       "IMDleast deprived                           \n",
       "IMDmoderate deprived                        \n",
       "Event_periodPostnatal                    ***\n",
       "mother_age                               ***\n",
       "BMI                                         \n",
       "baby_year_of_birth2017                   *  \n",
       "baby_year_of_birth2018                   ***\n",
       "baby_year_of_birth2019                   ***\n",
       "baby_year_of_birth2020                   ***\n",
       "baby_year_of_birth2021                   ***\n",
       "baby_year_of_birth2022                   ***\n",
       "complex_social_factors_indicatoryes      .  \n",
       "Speaks_EnglishYes                           \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 6213.7  on 9367  degrees of freedom\n",
       "Residual deviance: 4501.0  on 9349  degrees of freedom\n",
       "AIC: 4539\n",
       "\n",
       "Number of Fisher Scoring iterations: 7\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##The full regression model\n",
    "pmh53<-pmh52%>%filter (Event_period !=\"Antenatal\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD,  Event_period,mother_age,BMI,baby_year_of_birth,Event_period,complex_social_factors_indicator,Speaks_English )%>%drop_na()\n",
    "modelE <- glm(pmh ~. , data = pmh53, family = binomial)\n",
    "summary(modelE)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 93,
   "id": "557fadc8-8909-433d-88de-378c9e0ce212",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A matrix: 19 × 4 of type dbl</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col></th><th scope=col>odds_ratio</th><th scope=col>2.5 %</th><th scope=col>97.5 %</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>(Intercept)</th><td> 1.3978</td><td> 4.05</td><td> 2.21</td><td> 7.44</td></tr>\n",
       "\t<tr><th scope=row>EthnicityAsian Pakistani</th><td> 0.2059</td><td> 1.23</td><td> 1.00</td><td> 1.51</td></tr>\n",
       "\t<tr><th scope=row>EthnicityOthers</th><td>-0.0719</td><td> 0.93</td><td> 0.75</td><td> 1.16</td></tr>\n",
       "\t<tr><th scope=row>EmploymentHomemaker not looking for work</th><td> 0.1825</td><td> 1.20</td><td> 1.02</td><td> 1.42</td></tr>\n",
       "\t<tr><th scope=row>Employmentothers</th><td> 0.4923</td><td> 1.64</td><td> 0.96</td><td> 2.95</td></tr>\n",
       "\t<tr><th scope=row>EmploymentUnemployed and seeking work</th><td> 0.5296</td><td> 1.70</td><td> 1.26</td><td> 2.31</td></tr>\n",
       "\t<tr><th scope=row>IMDleast deprived</th><td>-0.1620</td><td> 0.85</td><td> 0.58</td><td> 1.26</td></tr>\n",
       "\t<tr><th scope=row>IMDmoderate deprived</th><td> 0.0409</td><td> 1.04</td><td> 0.78</td><td> 1.41</td></tr>\n",
       "\t<tr><th scope=row>Event_periodPostnatal</th><td> 3.5716</td><td>35.57</td><td>27.36</td><td>47.17</td></tr>\n",
       "\t<tr><th scope=row>mother_age</th><td>-0.0444</td><td> 0.96</td><td> 0.94</td><td> 0.97</td></tr>\n",
       "\t<tr><th scope=row>BMI</th><td>-0.0061</td><td> 0.99</td><td> 0.98</td><td> 1.01</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2017</th><td> 0.3524</td><td> 1.42</td><td> 1.01</td><td> 2.00</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2018</th><td> 0.9273</td><td> 2.53</td><td> 1.86</td><td> 3.44</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2019</th><td> 0.7999</td><td> 2.23</td><td> 1.65</td><td> 3.00</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2020</th><td> 0.8501</td><td> 2.34</td><td> 1.72</td><td> 3.18</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2021</th><td> 1.2460</td><td> 3.48</td><td> 2.47</td><td> 4.89</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2022</th><td> 2.0293</td><td> 7.61</td><td> 4.72</td><td>12.65</td></tr>\n",
       "\t<tr><th scope=row>complex_social_factors_indicatoryes</th><td> 0.3149</td><td> 1.37</td><td> 0.99</td><td> 1.94</td></tr>\n",
       "\t<tr><th scope=row>Speaks_EnglishYes</th><td> 0.0820</td><td> 1.09</td><td> 0.87</td><td> 1.34</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A matrix: 19 × 4 of type dbl\n",
       "\\begin{tabular}{r|llll}\n",
       "  &  & odds\\_ratio & 2.5 \\% & 97.5 \\%\\\\\n",
       "\\hline\n",
       "\t(Intercept) &  1.3978 &  4.05 &  2.21 &  7.44\\\\\n",
       "\tEthnicityAsian Pakistani &  0.2059 &  1.23 &  1.00 &  1.51\\\\\n",
       "\tEthnicityOthers & -0.0719 &  0.93 &  0.75 &  1.16\\\\\n",
       "\tEmploymentHomemaker not looking for work &  0.1825 &  1.20 &  1.02 &  1.42\\\\\n",
       "\tEmploymentothers &  0.4923 &  1.64 &  0.96 &  2.95\\\\\n",
       "\tEmploymentUnemployed and seeking work &  0.5296 &  1.70 &  1.26 &  2.31\\\\\n",
       "\tIMDleast deprived & -0.1620 &  0.85 &  0.58 &  1.26\\\\\n",
       "\tIMDmoderate deprived &  0.0409 &  1.04 &  0.78 &  1.41\\\\\n",
       "\tEvent\\_periodPostnatal &  3.5716 & 35.57 & 27.36 & 47.17\\\\\n",
       "\tmother\\_age & -0.0444 &  0.96 &  0.94 &  0.97\\\\\n",
       "\tBMI & -0.0061 &  0.99 &  0.98 &  1.01\\\\\n",
       "\tbaby\\_year\\_of\\_birth2017 &  0.3524 &  1.42 &  1.01 &  2.00\\\\\n",
       "\tbaby\\_year\\_of\\_birth2018 &  0.9273 &  2.53 &  1.86 &  3.44\\\\\n",
       "\tbaby\\_year\\_of\\_birth2019 &  0.7999 &  2.23 &  1.65 &  3.00\\\\\n",
       "\tbaby\\_year\\_of\\_birth2020 &  0.8501 &  2.34 &  1.72 &  3.18\\\\\n",
       "\tbaby\\_year\\_of\\_birth2021 &  1.2460 &  3.48 &  2.47 &  4.89\\\\\n",
       "\tbaby\\_year\\_of\\_birth2022 &  2.0293 &  7.61 &  4.72 & 12.65\\\\\n",
       "\tcomplex\\_social\\_factors\\_indicatoryes &  0.3149 &  1.37 &  0.99 &  1.94\\\\\n",
       "\tSpeaks\\_EnglishYes &  0.0820 &  1.09 &  0.87 &  1.34\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A matrix: 19 × 4 of type dbl\n",
       "\n",
       "| <!--/--> | <!----> | odds_ratio | 2.5 % | 97.5 % |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept) |  1.3978 |  4.05 |  2.21 |  7.44 |\n",
       "| EthnicityAsian Pakistani |  0.2059 |  1.23 |  1.00 |  1.51 |\n",
       "| EthnicityOthers | -0.0719 |  0.93 |  0.75 |  1.16 |\n",
       "| EmploymentHomemaker not looking for work |  0.1825 |  1.20 |  1.02 |  1.42 |\n",
       "| Employmentothers |  0.4923 |  1.64 |  0.96 |  2.95 |\n",
       "| EmploymentUnemployed and seeking work |  0.5296 |  1.70 |  1.26 |  2.31 |\n",
       "| IMDleast deprived | -0.1620 |  0.85 |  0.58 |  1.26 |\n",
       "| IMDmoderate deprived |  0.0409 |  1.04 |  0.78 |  1.41 |\n",
       "| Event_periodPostnatal |  3.5716 | 35.57 | 27.36 | 47.17 |\n",
       "| mother_age | -0.0444 |  0.96 |  0.94 |  0.97 |\n",
       "| BMI | -0.0061 |  0.99 |  0.98 |  1.01 |\n",
       "| baby_year_of_birth2017 |  0.3524 |  1.42 |  1.01 |  2.00 |\n",
       "| baby_year_of_birth2018 |  0.9273 |  2.53 |  1.86 |  3.44 |\n",
       "| baby_year_of_birth2019 |  0.7999 |  2.23 |  1.65 |  3.00 |\n",
       "| baby_year_of_birth2020 |  0.8501 |  2.34 |  1.72 |  3.18 |\n",
       "| baby_year_of_birth2021 |  1.2460 |  3.48 |  2.47 |  4.89 |\n",
       "| baby_year_of_birth2022 |  2.0293 |  7.61 |  4.72 | 12.65 |\n",
       "| complex_social_factors_indicatoryes |  0.3149 |  1.37 |  0.99 |  1.94 |\n",
       "| Speaks_EnglishYes |  0.0820 |  1.09 |  0.87 |  1.34 |\n",
       "\n"
      ],
      "text/plain": [
       "                                                 odds_ratio 2.5 % 97.5 %\n",
       "(Intercept)                               1.3978  4.05       2.21  7.44 \n",
       "EthnicityAsian Pakistani                  0.2059  1.23       1.00  1.51 \n",
       "EthnicityOthers                          -0.0719  0.93       0.75  1.16 \n",
       "EmploymentHomemaker not looking for work  0.1825  1.20       1.02  1.42 \n",
       "Employmentothers                          0.4923  1.64       0.96  2.95 \n",
       "EmploymentUnemployed and seeking work     0.5296  1.70       1.26  2.31 \n",
       "IMDleast deprived                        -0.1620  0.85       0.58  1.26 \n",
       "IMDmoderate deprived                      0.0409  1.04       0.78  1.41 \n",
       "Event_periodPostnatal                     3.5716 35.57      27.36 47.17 \n",
       "mother_age                               -0.0444  0.96       0.94  0.97 \n",
       "BMI                                      -0.0061  0.99       0.98  1.01 \n",
       "baby_year_of_birth2017                    0.3524  1.42       1.01  2.00 \n",
       "baby_year_of_birth2018                    0.9273  2.53       1.86  3.44 \n",
       "baby_year_of_birth2019                    0.7999  2.23       1.65  3.00 \n",
       "baby_year_of_birth2020                    0.8501  2.34       1.72  3.18 \n",
       "baby_year_of_birth2021                    1.2460  3.48       2.47  4.89 \n",
       "baby_year_of_birth2022                    2.0293  7.61       4.72 12.65 \n",
       "complex_social_factors_indicatoryes       0.3149  1.37       0.99  1.94 \n",
       "Speaks_EnglishYes                         0.0820  1.09       0.87  1.34 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "options(digits=2)\n",
    "tableE<-cbind(coef(modelE),odds_ratio=exp(coef(modelE)),exp(confint(modelE)))\n",
    "tableE\n",
    "\n",
    "E<-plot_model(modelE,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.5,50), vline.color = \"red\", title = \"Screening for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelE.jpg\", fig = E)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 97,
   "id": "a1b357b4-9fe7-41c6-ba76-db30ea75f26d",
   "metadata": {},
   "outputs": [],
   "source": [
    "options(digits=2)\n",
    "write.csv(tableE,\"modelE.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 100,
   "id": "80bedf62-2690-4e5a-a7e3-203dcf33f3ef",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh ~ Ethnicity + Employment + Event_period + mother_age + \n",
       "    baby_year_of_birth + complex_social_factors_indicator, family = binomial, \n",
       "    data = pmh53)\n",
       "\n",
       "Deviance Residuals: \n",
       "   Min      1Q  Median      3Q     Max  \n",
       "-3.394   0.113   0.148   0.532   1.298  \n",
       "\n",
       "Coefficients:\n",
       "                                         Estimate Std. Error z value Pr(>|z|)\n",
       "(Intercept)                               1.33436    0.24959    5.35  9.0e-08\n",
       "EthnicityAsian Pakistani                  0.21679    0.09985    2.17  0.02993\n",
       "EthnicityOthers                          -0.06873    0.10644   -0.65  0.51847\n",
       "EmploymentHomemaker not looking for work  0.16911    0.08202    2.06  0.03923\n",
       "Employmentothers                          0.48334    0.28378    1.70  0.08853\n",
       "EmploymentUnemployed and seeking work     0.53002    0.15242    3.48  0.00051\n",
       "Event_periodPostnatal                     3.57378    0.13864   25.78  < 2e-16\n",
       "mother_age                               -0.04568    0.00728   -6.28  3.5e-10\n",
       "baby_year_of_birth2017                    0.35725    0.17420    2.05  0.04028\n",
       "baby_year_of_birth2018                    0.93276    0.15690    5.94  2.8e-09\n",
       "baby_year_of_birth2019                    0.80233    0.15332    5.23  1.7e-07\n",
       "baby_year_of_birth2020                    0.85161    0.15699    5.42  5.8e-08\n",
       "baby_year_of_birth2021                    1.24584    0.17350    7.18  6.9e-13\n",
       "baby_year_of_birth2022                    2.03470    0.25043    8.12  4.5e-16\n",
       "complex_social_factors_indicatoryes       0.32976    0.17168    1.92  0.05476\n",
       "                                            \n",
       "(Intercept)                              ***\n",
       "EthnicityAsian Pakistani                 *  \n",
       "EthnicityOthers                             \n",
       "EmploymentHomemaker not looking for work *  \n",
       "Employmentothers                         .  \n",
       "EmploymentUnemployed and seeking work    ***\n",
       "Event_periodPostnatal                    ***\n",
       "mother_age                               ***\n",
       "baby_year_of_birth2017                   *  \n",
       "baby_year_of_birth2018                   ***\n",
       "baby_year_of_birth2019                   ***\n",
       "baby_year_of_birth2020                   ***\n",
       "baby_year_of_birth2021                   ***\n",
       "baby_year_of_birth2022                   ***\n",
       "complex_social_factors_indicatoryes      .  \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 6213.7  on 9367  degrees of freedom\n",
       "Residual deviance: 4503.1  on 9353  degrees of freedom\n",
       "AIC: 4533\n",
       "\n",
       "Number of Fisher Scoring iterations: 7\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "###Step wise regression model\n",
    "pmh53<-pmh52%>%filter (Event_period !=\"Antenatal\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD,  Event_period,mother_age,BMI,baby_year_of_birth,Event_period,complex_social_factors_indicator,Speaks_English )%>%drop_na()\n",
    "modelE1 <- glm(pmh ~. , data = pmh53, family = binomial)%>%\n",
    "  stepAIC(trace = FALSE) \n",
    "summary(modelE1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 101,
   "id": "8fa75dfc-426c-4e60-8718-3c0eef51d8dc",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                                                 odds_ratio 2.5 % 97.5 %\n",
      "(Intercept)                               1.3978       4.05  2.21   7.44\n",
      "EthnicityAsian Pakistani                  0.2059       1.23  1.00   1.51\n",
      "EthnicityOthers                          -0.0719       0.93  0.75   1.16\n",
      "EmploymentHomemaker not looking for work  0.1825       1.20  1.02   1.42\n",
      "Employmentothers                          0.4923       1.64  0.96   2.95\n",
      "EmploymentUnemployed and seeking work     0.5296       1.70  1.26   2.31\n",
      "IMDleast deprived                        -0.1620       0.85  0.58   1.26\n",
      "IMDmoderate deprived                      0.0409       1.04  0.78   1.41\n",
      "Event_periodPostnatal                     3.5716      35.57 27.36  47.17\n",
      "mother_age                               -0.0444       0.96  0.94   0.97\n",
      "BMI                                      -0.0061       0.99  0.98   1.01\n",
      "baby_year_of_birth2017                    0.3524       1.42  1.01   2.00\n",
      "baby_year_of_birth2018                    0.9273       2.53  1.86   3.44\n",
      "baby_year_of_birth2019                    0.7999       2.23  1.65   3.00\n",
      "baby_year_of_birth2020                    0.8501       2.34  1.72   3.18\n",
      "baby_year_of_birth2021                    1.2460       3.48  2.47   4.89\n",
      "baby_year_of_birth2022                    2.0293       7.61  4.72  12.65\n",
      "complex_social_factors_indicatoryes       0.3149       1.37  0.99   1.94\n",
      "Speaks_EnglishYes                         0.0820       1.09  0.87   1.34\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "tableE1<-cbind(coef(modelE1),odds_ratio=exp(coef(modelE1)),exp(confint(modelE1)))\n",
    "print(tableE,digits = 2)\n",
    "E1<-plot_model(modelE1,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.5,50), vline.color = \"red\", title = \"Screening for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelE1.jpg\", fig = E1)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 104,
   "id": "10fa014a-ed32-412d-a3ad-13983c3f49e0",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh53a<-pmh52%>%filter( Event_period==\"Postnatal\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD, Speaks_English,Event_period )%>%drop_na()\n",
    "pmh53b<-pmh52%>%filter( Event_period==\"Both\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD, Speaks_English,Event_period )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 108,
   "id": "60bdfce6-91c1-434f-ab6d-7506dde04fe9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh ~ ., family = binomial, data = pmh53a)\n",
       "\n",
       "Deviance Residuals: \n",
       "   Min      1Q  Median      3Q     Max  \n",
       "-3.627   0.062   0.093   0.137   0.562  \n",
       "\n",
       "Coefficients:\n",
       "                                         Estimate Std. Error z value Pr(>|z|)\n",
       "(Intercept)                               5.28813    1.19784    4.41  1.0e-05\n",
       "EthnicityAsian Pakistani                  1.80148    0.39553    4.55  5.2e-06\n",
       "EthnicityOthers                           0.75675    0.33613    2.25    0.024\n",
       "EmploymentHomemaker not looking for work  0.91514    0.41000    2.23    0.026\n",
       "Employmentothers                          0.29777    1.03690    0.29    0.774\n",
       "EmploymentUnemployed and seeking work     0.32654    0.55201    0.59    0.554\n",
       "IMDleast deprived                        -1.19232    0.40223   -2.96    0.003\n",
       "IMDmoderate deprived                     -0.80850    0.36897   -2.19    0.028\n",
       "mother_age                               -0.04064    0.02632   -1.54    0.123\n",
       "BMI                                      -0.01554    0.02116   -0.73    0.463\n",
       "baby_year_of_birth2017                    0.03841    0.62285    0.06    0.951\n",
       "baby_year_of_birth2018                    0.31142    0.56709    0.55    0.583\n",
       "baby_year_of_birth2019                    0.19310    0.53332    0.36    0.717\n",
       "baby_year_of_birth2020                    0.24331    0.53631    0.45    0.650\n",
       "baby_year_of_birth2021                    2.04798    0.74538    2.75    0.006\n",
       "baby_year_of_birth2022                    0.99840    0.75028    1.33    0.183\n",
       "complex_social_factors_indicatoryes       0.00647    0.63190    0.01    0.992\n",
       "Speaks_EnglishYes                        -0.50605    0.62606   -0.81    0.419\n",
       "                                            \n",
       "(Intercept)                              ***\n",
       "EthnicityAsian Pakistani                 ***\n",
       "EthnicityOthers                          *  \n",
       "EmploymentHomemaker not looking for work *  \n",
       "Employmentothers                            \n",
       "EmploymentUnemployed and seeking work       \n",
       "IMDleast deprived                        ** \n",
       "IMDmoderate deprived                     *  \n",
       "mother_age                                  \n",
       "BMI                                         \n",
       "baby_year_of_birth2017                      \n",
       "baby_year_of_birth2018                      \n",
       "baby_year_of_birth2019                      \n",
       "baby_year_of_birth2020                      \n",
       "baby_year_of_birth2021                   ** \n",
       "baby_year_of_birth2022                      \n",
       "complex_social_factors_indicatoryes         \n",
       "Speaks_EnglishYes                           \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 649.92  on 5814  degrees of freedom\n",
       "Residual deviance: 557.62  on 5797  degrees of freedom\n",
       "AIC: 593.6\n",
       "\n",
       "Number of Fisher Scoring iterations: 9\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##logistic regression model for postnatal cases only\n",
    "pmh53a<-pmh52%>%filter( Event_period==\"Postnatal\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD,  mother_age,BMI,baby_year_of_birth,complex_social_factors_indicator,Speaks_English )%>%drop_na()\n",
    "modela <- glm(pmh ~. , data = pmh53a, family = binomial)\n",
    "summary(modela)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 110,
   "id": "ef96298d-fef7-426c-894a-648c7b60a2fd",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A matrix: 18 × 4 of type dbl</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col></th><th scope=col>odds_ratio</th><th scope=col>2.5 %</th><th scope=col>97.5 %</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>(Intercept)</th><td> 5.2881</td><td>197.97</td><td>20.17</td><td>2269.90</td></tr>\n",
       "\t<tr><th scope=row>EthnicityAsian Pakistani</th><td> 1.8015</td><td>  6.06</td><td> 2.87</td><td>  13.74</td></tr>\n",
       "\t<tr><th scope=row>EthnicityOthers</th><td> 0.7568</td><td>  2.13</td><td> 1.12</td><td>   4.22</td></tr>\n",
       "\t<tr><th scope=row>EmploymentHomemaker not looking for work</th><td> 0.9151</td><td>  2.50</td><td> 1.17</td><td>   5.97</td></tr>\n",
       "\t<tr><th scope=row>Employmentothers</th><td> 0.2978</td><td>  1.35</td><td> 0.27</td><td>  24.47</td></tr>\n",
       "\t<tr><th scope=row>EmploymentUnemployed and seeking work</th><td> 0.3265</td><td>  1.39</td><td> 0.52</td><td>   4.81</td></tr>\n",
       "\t<tr><th scope=row>IMDleast deprived</th><td>-1.1923</td><td>  0.30</td><td> 0.14</td><td>   0.70</td></tr>\n",
       "\t<tr><th scope=row>IMDmoderate deprived</th><td>-0.8085</td><td>  0.45</td><td> 0.22</td><td>   0.96</td></tr>\n",
       "\t<tr><th scope=row>mother_age</th><td>-0.0406</td><td>  0.96</td><td> 0.91</td><td>   1.01</td></tr>\n",
       "\t<tr><th scope=row>BMI</th><td>-0.0155</td><td>  0.98</td><td> 0.95</td><td>   1.03</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2017</th><td> 0.0384</td><td>  1.04</td><td> 0.29</td><td>   3.56</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2018</th><td> 0.3114</td><td>  1.37</td><td> 0.41</td><td>   4.00</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2019</th><td> 0.1931</td><td>  1.21</td><td> 0.38</td><td>   3.24</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2020</th><td> 0.2433</td><td>  1.28</td><td> 0.40</td><td>   3.44</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2021</th><td> 2.0480</td><td>  7.75</td><td> 1.85</td><td>  38.70</td></tr>\n",
       "\t<tr><th scope=row>baby_year_of_birth2022</th><td> 0.9984</td><td>  2.71</td><td> 0.64</td><td>  13.65</td></tr>\n",
       "\t<tr><th scope=row>complex_social_factors_indicatoryes</th><td> 0.0065</td><td>  1.01</td><td> 0.34</td><td>   4.36</td></tr>\n",
       "\t<tr><th scope=row>Speaks_EnglishYes</th><td>-0.5061</td><td>  0.60</td><td> 0.14</td><td>   1.79</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A matrix: 18 × 4 of type dbl\n",
       "\\begin{tabular}{r|llll}\n",
       "  &  & odds\\_ratio & 2.5 \\% & 97.5 \\%\\\\\n",
       "\\hline\n",
       "\t(Intercept) &  5.2881 & 197.97 & 20.17 & 2269.90\\\\\n",
       "\tEthnicityAsian Pakistani &  1.8015 &   6.06 &  2.87 &   13.74\\\\\n",
       "\tEthnicityOthers &  0.7568 &   2.13 &  1.12 &    4.22\\\\\n",
       "\tEmploymentHomemaker not looking for work &  0.9151 &   2.50 &  1.17 &    5.97\\\\\n",
       "\tEmploymentothers &  0.2978 &   1.35 &  0.27 &   24.47\\\\\n",
       "\tEmploymentUnemployed and seeking work &  0.3265 &   1.39 &  0.52 &    4.81\\\\\n",
       "\tIMDleast deprived & -1.1923 &   0.30 &  0.14 &    0.70\\\\\n",
       "\tIMDmoderate deprived & -0.8085 &   0.45 &  0.22 &    0.96\\\\\n",
       "\tmother\\_age & -0.0406 &   0.96 &  0.91 &    1.01\\\\\n",
       "\tBMI & -0.0155 &   0.98 &  0.95 &    1.03\\\\\n",
       "\tbaby\\_year\\_of\\_birth2017 &  0.0384 &   1.04 &  0.29 &    3.56\\\\\n",
       "\tbaby\\_year\\_of\\_birth2018 &  0.3114 &   1.37 &  0.41 &    4.00\\\\\n",
       "\tbaby\\_year\\_of\\_birth2019 &  0.1931 &   1.21 &  0.38 &    3.24\\\\\n",
       "\tbaby\\_year\\_of\\_birth2020 &  0.2433 &   1.28 &  0.40 &    3.44\\\\\n",
       "\tbaby\\_year\\_of\\_birth2021 &  2.0480 &   7.75 &  1.85 &   38.70\\\\\n",
       "\tbaby\\_year\\_of\\_birth2022 &  0.9984 &   2.71 &  0.64 &   13.65\\\\\n",
       "\tcomplex\\_social\\_factors\\_indicatoryes &  0.0065 &   1.01 &  0.34 &    4.36\\\\\n",
       "\tSpeaks\\_EnglishYes & -0.5061 &   0.60 &  0.14 &    1.79\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A matrix: 18 × 4 of type dbl\n",
       "\n",
       "| <!--/--> | <!----> | odds_ratio | 2.5 % | 97.5 % |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept) |  5.2881 | 197.97 | 20.17 | 2269.90 |\n",
       "| EthnicityAsian Pakistani |  1.8015 |   6.06 |  2.87 |   13.74 |\n",
       "| EthnicityOthers |  0.7568 |   2.13 |  1.12 |    4.22 |\n",
       "| EmploymentHomemaker not looking for work |  0.9151 |   2.50 |  1.17 |    5.97 |\n",
       "| Employmentothers |  0.2978 |   1.35 |  0.27 |   24.47 |\n",
       "| EmploymentUnemployed and seeking work |  0.3265 |   1.39 |  0.52 |    4.81 |\n",
       "| IMDleast deprived | -1.1923 |   0.30 |  0.14 |    0.70 |\n",
       "| IMDmoderate deprived | -0.8085 |   0.45 |  0.22 |    0.96 |\n",
       "| mother_age | -0.0406 |   0.96 |  0.91 |    1.01 |\n",
       "| BMI | -0.0155 |   0.98 |  0.95 |    1.03 |\n",
       "| baby_year_of_birth2017 |  0.0384 |   1.04 |  0.29 |    3.56 |\n",
       "| baby_year_of_birth2018 |  0.3114 |   1.37 |  0.41 |    4.00 |\n",
       "| baby_year_of_birth2019 |  0.1931 |   1.21 |  0.38 |    3.24 |\n",
       "| baby_year_of_birth2020 |  0.2433 |   1.28 |  0.40 |    3.44 |\n",
       "| baby_year_of_birth2021 |  2.0480 |   7.75 |  1.85 |   38.70 |\n",
       "| baby_year_of_birth2022 |  0.9984 |   2.71 |  0.64 |   13.65 |\n",
       "| complex_social_factors_indicatoryes |  0.0065 |   1.01 |  0.34 |    4.36 |\n",
       "| Speaks_EnglishYes | -0.5061 |   0.60 |  0.14 |    1.79 |\n",
       "\n"
      ],
      "text/plain": [
       "                                                 odds_ratio 2.5 % 97.5 % \n",
       "(Intercept)                               5.2881 197.97     20.17 2269.90\n",
       "EthnicityAsian Pakistani                  1.8015   6.06      2.87   13.74\n",
       "EthnicityOthers                           0.7568   2.13      1.12    4.22\n",
       "EmploymentHomemaker not looking for work  0.9151   2.50      1.17    5.97\n",
       "Employmentothers                          0.2978   1.35      0.27   24.47\n",
       "EmploymentUnemployed and seeking work     0.3265   1.39      0.52    4.81\n",
       "IMDleast deprived                        -1.1923   0.30      0.14    0.70\n",
       "IMDmoderate deprived                     -0.8085   0.45      0.22    0.96\n",
       "mother_age                               -0.0406   0.96      0.91    1.01\n",
       "BMI                                      -0.0155   0.98      0.95    1.03\n",
       "baby_year_of_birth2017                    0.0384   1.04      0.29    3.56\n",
       "baby_year_of_birth2018                    0.3114   1.37      0.41    4.00\n",
       "baby_year_of_birth2019                    0.1931   1.21      0.38    3.24\n",
       "baby_year_of_birth2020                    0.2433   1.28      0.40    3.44\n",
       "baby_year_of_birth2021                    2.0480   7.75      1.85   38.70\n",
       "baby_year_of_birth2022                    0.9984   2.71      0.64   13.65\n",
       "complex_social_factors_indicatoryes       0.0065   1.01      0.34    4.36\n",
       "Speaks_EnglishYes                        -0.5061   0.60      0.14    1.79"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "options(digits=2)\n",
    "tablea<-cbind(coef(modela),odds_ratio=exp(coef(modela)),exp(confint(modela)))\n",
    "tablea\n",
    "A<-plot_model(modela,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.1,50), vline.color = \"red\", title = \"Screening for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelA.jpg\", fig = A)\n",
    "write.csv(tablea,\"modela.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 111,
   "id": "9a2a709a-5421-4a1f-8b6e-ef4d8a977340",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh ~ ., family = binomial, data = pmh53b)\n",
       "\n",
       "Deviance Residuals: \n",
       "   Min      1Q  Median      3Q     Max  \n",
       "-2.571  -1.160   0.680   0.801   1.309  \n",
       "\n",
       "Coefficients:\n",
       "                                         Estimate Std. Error z value Pr(>|z|)\n",
       "(Intercept)                               1.46724    0.32431    4.52  6.1e-06\n",
       "EthnicityAsian Pakistani                  0.05235    0.11016    0.48   0.6346\n",
       "EthnicityOthers                          -0.18860    0.11782   -1.60   0.1094\n",
       "EmploymentHomemaker not looking for work  0.13103    0.08809    1.49   0.1369\n",
       "Employmentothers                          0.48285    0.29482    1.64   0.1015\n",
       "EmploymentUnemployed and seeking work     0.52034    0.15976    3.26   0.0011\n",
       "IMDleast deprived                         0.08813    0.21536    0.41   0.6824\n",
       "IMDmoderate deprived                      0.17937    0.16202    1.11   0.2683\n",
       "mother_age                               -0.04541    0.00771   -5.89  3.8e-09\n",
       "BMI                                      -0.00480    0.00668   -0.72   0.4719\n",
       "baby_year_of_birth2017                    0.36580    0.18362    1.99   0.0464\n",
       "baby_year_of_birth2018                    0.96666    0.16489    5.86  4.6e-09\n",
       "baby_year_of_birth2019                    0.84484    0.16154    5.23  1.7e-07\n",
       "baby_year_of_birth2020                    0.89410    0.16566    5.40  6.8e-08\n",
       "baby_year_of_birth2021                    1.17700    0.18209    6.46  1.0e-10\n",
       "baby_year_of_birth2022                    2.12064    0.26638    7.96  1.7e-15\n",
       "complex_social_factors_indicatoryes       0.32618    0.17823    1.83   0.0672\n",
       "Speaks_EnglishYes                         0.09347    0.11354    0.82   0.4104\n",
       "                                            \n",
       "(Intercept)                              ***\n",
       "EthnicityAsian Pakistani                    \n",
       "EthnicityOthers                             \n",
       "EmploymentHomemaker not looking for work    \n",
       "Employmentothers                            \n",
       "EmploymentUnemployed and seeking work    ** \n",
       "IMDleast deprived                           \n",
       "IMDmoderate deprived                        \n",
       "mother_age                               ***\n",
       "BMI                                         \n",
       "baby_year_of_birth2017                   *  \n",
       "baby_year_of_birth2018                   ***\n",
       "baby_year_of_birth2019                   ***\n",
       "baby_year_of_birth2020                   ***\n",
       "baby_year_of_birth2021                   ***\n",
       "baby_year_of_birth2022                   ***\n",
       "complex_social_factors_indicatoryes      .  \n",
       "Speaks_EnglishYes                           \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 4036.6  on 3552  degrees of freedom\n",
       "Residual deviance: 3864.9  on 3535  degrees of freedom\n",
       "AIC: 3901\n",
       "\n",
       "Number of Fisher Scoring iterations: 4\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "\n",
    "##Regression analysis for cases who screened for both antenatal nand postnatal\n",
    "pmh53b<-pmh52%>%filter( Event_period==\"Both\")%>%dplyr::select(pmh,Ethnicity, Employment, IMD,  mother_age,BMI,baby_year_of_birth,complex_social_factors_indicator,Speaks_English )%>%drop_na()\n",
    "modelb <- glm(pmh ~. , data = pmh53b, family = binomial)\n",
    "summary(modelb)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 112,
   "id": "8f288b59-3532-48dd-bb57-7bda37a16a59",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                                                 odds_ratio 2.5 % 97.5 %\n",
      "(Intercept)                               1.4672       4.34  2.30   8.20\n",
      "EthnicityAsian Pakistani                  0.0523       1.05  0.85   1.31\n",
      "EthnicityOthers                          -0.1886       0.83  0.66   1.04\n",
      "EmploymentHomemaker not looking for work  0.1310       1.14  0.96   1.36\n",
      "Employmentothers                          0.4829       1.62  0.93   2.99\n",
      "EmploymentUnemployed and seeking work     0.5203       1.68  1.24   2.32\n",
      "IMDleast deprived                         0.0881       1.09  0.72   1.69\n",
      "IMDmoderate deprived                      0.1794       1.20  0.88   1.66\n",
      "mother_age                               -0.0454       0.96  0.94   0.97\n",
      "BMI                                      -0.0048       1.00  0.98   1.01\n",
      "baby_year_of_birth2017                    0.3658       1.44  1.01   2.07\n",
      "baby_year_of_birth2018                    0.9667       2.63  1.90   3.63\n",
      "baby_year_of_birth2019                    0.8448       2.33  1.69   3.19\n",
      "baby_year_of_birth2020                    0.8941       2.45  1.77   3.38\n",
      "baby_year_of_birth2021                    1.1770       3.24  2.27   4.64\n",
      "baby_year_of_birth2022                    2.1206       8.34  5.03  14.34\n",
      "complex_social_factors_indicatoryes       0.3262       1.39  0.99   1.99\n",
      "Speaks_EnglishYes                         0.0935       1.10  0.88   1.37\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "options(digits=2)\n",
    "tableb<-cbind(coef(modelb),odds_ratio=exp(coef(modelb)),exp(confint(modelb)))\n",
    "print(tableb,digits = 2)\n",
    "B<-plot_model(modelb,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.1,50), vline.color = \"red\", title = \"Screening for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelB.jpg\", fig = B)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f3f93157-dffd-4293-88ae-2717fc6acff1",
   "metadata": {},
   "outputs": [],
   "source": [
    "####Factor affecting the PMH problems and descriptive varraibles \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6a765d40-5cb0-4f1e-9e0b-dfabc7444e14",
   "metadata": {},
   "outputs": [],
   "source": [
    "##indication for perinatal mental health problems (visits)\n",
    "pmh1_visit<-pmh_final%>%  group_by( event_year,pmh_problems) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na(pmh_problems)%>%\n",
    "ggplot( aes(x=as.factor(event_year), y=count, fill=pmh_problems)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=-0.2, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ theme_classic()+xlab(\"YEAR\")\n",
    "save_plot(filename = \"pmh1_visit.jpg\", fig = pmh1_visit)\n",
    "\n",
    "pmh1_visit1<-pmh_final%>%select(child_person_id, event_year, pmh_problems)%>%distinct()\n",
    "\n",
    "pmh1_visit12<-plot_xtab(\n",
    "  x   = pmh_final$event_year, \n",
    "  grp = pmh_final$pmh_problems, \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"stack\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"pmh1_visit12.jpg\", fig = pmh1_visit12)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ae8f2819-9b95-4843-9462-dfeb6db4a88b",
   "metadata": {},
   "outputs": [],
   "source": [
    "str(pmhpro)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 113,
   "id": "206a196a-182d-4ec2-936c-3fe7f0a170b6",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(person_id)`\n",
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    }
   ],
   "source": [
    "##cleaning the data (if have both yes and no for pmh  choose only yes)\n",
    "pmh2_true<-pmh_final%>%filter(pmh_problems==\"yes\")%>%distinct()\n",
    "pmh2_false<-pmh_final%>%filter(pmh_problems==\"no\")%>%distinct()\n",
    "pmh2_false1<-anti_join(pmh2_false, pmh2_true, by=\"child_person_id\")%>%distinct()\n",
    "pmhpro<- bind_rows(pmh2_true,pmh2_false1)%>% dplyr::select(-c(Family_history, pmh_medication, event_year,pmh))%>%distinct()\n",
    "pmhpro<-left_join(pmhpro,pmh_fh)%>%distinct()\n",
    "pmhpro<-left_join(pmhpro, pmh_med)%>%distinct()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 116,
   "id": "06ac0989-7a2d-4f09-82f4-1793f9bbb766",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(child_person_id)`\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [32,186 × 21] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                 : int [1:32186] 8448253 12655334 13424191 13542759 1040492 13122567 12647542 13371312 12905236 13670157 ...\n",
      " $ child_person_id                           : int [1:32186] 14993025 12601918 13185264 14989821 14992132 14993653 14990982 14992050 13071420 14780783 ...\n",
      " $ baby_year_of_birth                        : Factor w/ 7 levels \"2016\",\"2017\",..: 7 1 2 7 7 7 7 7 1 7 ...\n",
      " $ Ethnicity                                 : Factor w/ 3 levels \"Asian Pakistani\",..: NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ Employment                                : Factor w/ 4 levels \"Employed\",\"Homemaker not looking for work\",..: 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ support                                   : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ physical_disability_code_mother_at_booking: Factor w/ 2 levels \"N\",\"Y\": 1 1 1 NA 1 1 1 1 1 1 ...\n",
      " $ mental_health_prediction                  : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 1 ...\n",
      " $ complex_social_factors_indicator          : Factor w/ 2 levels \"no\",\"yes\": 2 NA NA NA NA 2 NA NA 2 NA ...\n",
      " $ BMI                                       : num [1:32186] NA 32 18.6 33.5 NA ...\n",
      " $ smoking                                   : Factor w/ 3 levels \"Current smoker\",..: NA 3 3 3 3 3 3 3 3 3 ...\n",
      " $ folic_acid                                : Factor w/ 3 levels \"not taken\",\"start taking once pregnant\",..: 2 3 2 2 2 2 2 2 2 2 ...\n",
      " $ substance_abuse                           : Factor w/ 3 levels \"currently using\",..: 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Speaks_English                            : Factor w/ 2 levels \"No\",\"Yes\": 2 2 NA NA 2 2 2 NA 2 2 ...\n",
      " $ Interpreter_needed                        : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 2 1 1 2 ...\n",
      " $ IMD                                       : Factor w/ 3 levels \"least deprived\",..: 2 NA NA NA NA 3 3 NA 3 3 ...\n",
      " $ mother_age                                : int [1:32186] NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ pmh_problems                              : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Family_history                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ pmh_medication                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ Event_period                              : chr [1:32186] \"Postnatal\" \"Postnatal\" \"Both\" \"Postnatal\" ...\n"
     ]
    }
   ],
   "source": [
    "##changing the data from longtiudinal to wide using perinatal period\n",
    "\n",
    "\n",
    "pmh61<-pmhpro%>%count(child_person_id, event_period,sort=TRUE)\n",
    " wide6=pmh61%>%spread(event_period, n)\n",
    " wide6$antenatal<-ifelse(is.na(wide6$antenatal), \"No\",\"Yes\")\n",
    "wide6$postnatal<-ifelse(is.na(wide6$postnatal), \"No\",\"Yes\")\n",
    "wide61<-wide6%>% mutate(Event_period= case_when(\n",
    "    antenatal == \"Yes\" & postnatal==\"Yes\"  ~ \"Both\" ,\n",
    "    antenatal == \"Yes\" ~ \"Antenatal\",\n",
    "    postnatal == \"Yes\"  ~ \"Postnatal\"))%>%dplyr::select(child_person_id,  Event_period)\n",
    "pmh62<-pmhpro%>%dplyr::select(-event_period)%>%distinct()\n",
    "pmh62<-left_join(pmh62, wide61)\n",
    "str(pmh62)\n",
    "write.csv(pmh62,\"pmh62.csv\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "821cae64-903e-4686-beb6-f9c9bc17b8fd",
   "metadata": {},
   "outputs": [],
   "source": [
    "##indication for perinatal mental health problems (patients)\n",
    "pmh_pro<-pmh62%>%  group_by( baby_year_of_birth,pmh_problems) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na(pmh_problems)%>%\n",
    "ggplot( aes(x=as.factor(baby_year_of_birth), y=count, fill=pmh_problems)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=1.6, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ theme_classic()+xlab(\"Baby year of Birth\")\n",
    "save_plot(filename = \"pmh_pro.jpg\", fig =pmh_pro)\n",
    "\n",
    "pmh1_pro<-pmh62%>%select(child_person_id, baby_year_of_birth, pmh_problems)%>%distinct()\n",
    "\n",
    "pmh1_pro1<-plot_xtab(\n",
    "  x   = pmh1_pro$baby_year_of_birth, \n",
    "  grp = pmh1_pro$pmh_problems, \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"stack\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = TRUE)+xlab(\"Baby year of Birth\")\n",
    "save_plot(filename = \"pmh_prob1.jpg\", fig = pmh1_pro1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "310bb3a2-8610-4e4b-a2d6-dc74ca9382d3",
   "metadata": {},
   "outputs": [],
   "source": [
    "##1 perinatal period\n",
    "pmh2_period<-pmhpro%>%select(child_person_id, event_period, pmh_problems )%>%distinct()%>% drop_na()\n",
    "period2<-plot_xtab(\n",
    "  x   = pmh2_period$event_period, \n",
    "  grp = pmh2_period$pmh_problems , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"period2.jpg\", fig = period2)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8f79025a-b6ec-47f0-81df-2a2d8a46dbed",
   "metadata": {},
   "outputs": [],
   "source": [
    "##perinatal period Yes only\n",
    "pmh_period2<-pmh62%>%filter( pmh_problems==\"yes\")%>%select(child_person_id, Event_period)%>%distinct()\n",
    "period21<-pmh_period2  %>% \n",
    "  plot_frq(Event_period )\n",
    "save_plot(filename = \"period21.jpg\", fig = period21)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b837083a-2a1d-437a-8f3c-c315f6cae330",
   "metadata": {},
   "outputs": [],
   "source": [
    "### maternal age\n",
    "pmh2_maternal<-pmh62%>%select(child_person_id, mother_age, pmh_problems)%>%distinct()\n",
    "g2 <- ggplot(pmh2_maternal, aes(pmh_problems,mother_age)) + geom_boxplot() + \n",
    "    labs(x=\"Indication of PMH\",\n",
    "         y=\"Maternal age\")+ stat_summary(fun.y=mean, geom=\"point\", shape=23, size=6)\n",
    "\n",
    "save_plot(filename = \"maternal2.jpg\", fig = g2)\n",
    "t.test(mother_age ~pmh_problems, data = pmh2_maternal)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4dcde9b5-c23a-4c71-8faa-00be8238e881",
   "metadata": {},
   "outputs": [],
   "source": [
    "### bmi\n",
    "pmh2_bmi<-pmh62%>%select(child_person_id, BMI, pmh_problems)%>%distinct()\n",
    "bmi2 <- ggplot(pmh2_bmi, aes(pmh_problems,BMI)) + geom_boxplot() + \n",
    "    labs(x=\"PMH problems\",\n",
    "         y=\"BMI\")+ stat_summary(fun.y=mean, geom=\"point\", shape=23, size=6)\n",
    "\n",
    "save_plot(filename = \"bmi2.jpg\", fig = bmi2)\n",
    "t.test(BMI ~pmh_problems, data = pmh2_bmi)\n",
    "wilcox.test(BMI ~pmh_problems, data = pmh2_bmi)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "06dd1e6f-817a-4169-8d5c-e9d429ac30c1",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Ethnicithy \n",
    "pmh2_eth<-pmh62%>%select(child_person_id, Ethnicity, pmh_problems)%>%distinct()\n",
    "Eth2<-plot_grpfrq(\n",
    "  pmh2_eth$Ethnicity, \n",
    "  pmh2_eth$pmh_problems , \n",
    "    show.summary = TRUE,\n",
    "  coord.flip   = FALSE,legend.title = \"Indication for PMH problems\")\n",
    "save_plot(filename = \"Eth2.jpg\", fig = Eth2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1f2ada8e-68d8-40df-af42-2ee5307932be",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Employment \n",
    "pmh2_emp<-pmh62%>%select(child_person_id, Employment, pmh_problems)%>%distinct()\n",
    "Emp2<-plot_grpfrq(\n",
    "   pmh2_emp$Employment, \n",
    "  pmh2_emp$pmh_problems ,ylim = c(0,15000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE,legend.title = \"Indication for PMH problems\")\n",
    "save_plot(filename = \"Emp2.jpg\", fig = Emp2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "56948551-83c9-44a3-bd8e-736676dbe0a5",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Speaking English\n",
    "pmh21_spe<-pmh62%>%select(child_person_id, Speaks_English, pmh_problems)%>%distinct()\n",
    "spe12<-plot_grpfrq(\n",
    "  pmh21_spe$Speaks_English, \n",
    "  pmh21_spe$pmh_problems,\n",
    "  geom.size = 0.5,show.summary = TRUE,legend.title = \"Indication for PMH problems\"\n",
    ")\n",
    "save_plot(filename = \"spe2.jpg\", fig = spe12)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2b6248de-329c-4f5c-ba4e-ca0a24afbd49",
   "metadata": {},
   "outputs": [],
   "source": [
    "##interperter needed\n",
    "pmh2_int<-pmh62%>%select(child_person_id, Interpreter_needed, pmh_problems)%>%distinct()\n",
    "int2<-plot_grpfrq(\n",
    " pmh2_int$Interpreter_needed, \n",
    "   pmh2_int$pmh_problems ,  \n",
    "  show.summary = TRUE,legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"int2.jpg\", fig = int2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fc5b7cdb-578c-4f65-91bc-b57c11aeadf9",
   "metadata": {},
   "outputs": [],
   "source": [
    "##support\n",
    "pmh2_support<-pmh62%>%select(child_person_id, support, pmh_problems)%>%distinct()\n",
    "support<-plot_grpfrq(\n",
    " pmh2_support$support, \n",
    " pmh2_support$pmh_problems ,\n",
    "  show.summary = TRUE, legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"support.jpg\", fig = support)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4ba48b32-2fae-4dbf-a7d2-552e18d14e32",
   "metadata": {},
   "outputs": [],
   "source": [
    "##IMD\n",
    "pmh2_IMD<-pmh62%>%select(child_person_id, IMD, pmh_problems)%>%distinct()\n",
    "IMD2<-plot_grpfrq(\n",
    "   pmh2_IMD$IMD, \n",
    "  pmh2_IMD$pmh_problems ,\n",
    "  show.summary = TRUE,legend.title = \"Indication for PMH problems\",ylim = c(0,20000),\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"IMD2.jpg\", fig = IMD2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5ab7e24b-0f14-46ea-b1d3-5fc0044ba7a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "##complex_social_factors_indicator\n",
    "pmh2_SI<-pmh62%>%select(child_person_id, complex_social_factors_indicator, pmh_problems)%>%distinct()\n",
    "SI<-plot_grpfrq(\n",
    " pmh2_SI$complex_social_factors_indicator, \n",
    " pmh2_SI$pmh_problems , \n",
    "  legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"SI.jpg\", fig = SI)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d052940d-3855-4561-b421-8ace20259584",
   "metadata": {},
   "outputs": [],
   "source": [
    "##physical_disability_code_mother_at_booking\n",
    "pmh2_PD<-pmh62%>%select(child_person_id,physical_disability_code_mother_at_booking, pmh_problems)%>%distinct()\n",
    "PD<-plot_grpfrq(\n",
    "  pmh2_PD$physical_disability_code_mother_at_booking, \n",
    "  pmh2_PD$pmh_problems , \n",
    "  legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"PD.jpg\", fig = PD)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "58ededbf-8648-4728-8ff4-6c9a37c18659",
   "metadata": {},
   "outputs": [],
   "source": [
    "##mental_health_prediction\n",
    "pmh2_MI<-pmh62%>%select(child_person_id,mental_health_prediction, pmh_problems)%>%distinct()\n",
    "MI<-plot_grpfrq(\n",
    " pmh2_MI$mental_health_prediction, \n",
    "  pmh2_MI$pmh_problems , \n",
    "  legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"MI.jpg\", fig = MI)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "faed9794-5e1b-4341-a745-ba0c1a7c81b0",
   "metadata": {},
   "outputs": [],
   "source": [
    "##substance_abuse\n",
    "pmh2_SA<-pmh62%>%select(child_person_id,substance_abuse, pmh_problems)%>%distinct()\n",
    "SA<-plot_grpfrq(\n",
    "pmh2_SA$substance_abuse, \n",
    "pmh2_SA$pmh_problems , \n",
    "  legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"SA.jpg\", fig = SA)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1c7495f6-0da0-4063-b5bf-7b0f82f4bc5c",
   "metadata": {},
   "outputs": [],
   "source": [
    "##smoking\n",
    "pmh2_smoking<-pmh62%>%select(child_person_id,smoking, pmh_problems)%>%distinct()\n",
    "smoking<-plot_grpfrq(\n",
    " pmh2_smoking$smoking, \n",
    " pmh2_smoking$pmh_problems , \n",
    "  legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"smoking.jpg\", fig = smoking)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "320928db-22c0-4eba-91ef-d319033f5cd0",
   "metadata": {},
   "outputs": [],
   "source": [
    "##folic acid\n",
    "pmh2_folic<-pmh62%>%select(child_person_id,folic_acid, pmh_problems)%>%distinct()\n",
    "folic<-plot_grpfrq(\n",
    "pmh2_folic$folic_acid, \n",
    "pmh2_folic$pmh_problems , \n",
    "legend.title = \"Indication for PMH problems\",ylim = c(0,25000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"folic.jpg\", fig = folic)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "63fcfb56-8e55-451a-b279-c90ce9bc5b1a",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Medication\n",
    "pmh2_med<-pmh62%>%select(child_person_id,pmh_medication, pmh_problems)%>%distinct()\n",
    "pmh_med<-plot_grpfrq(\n",
    "pmh2_med$pmh_medication, \n",
    "pmh2_med$pmh_problems , \n",
    "legend.title = \"Indication for PMH problems\",ylim = c(0,30000),\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"pmh_med.jpg\", fig = pmh_med)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4b758dad-35e4-4057-96c0-9f74c7c8f220",
   "metadata": {},
   "outputs": [],
   "source": [
    "#medication 2\n",
    "\n",
    "med1<-plot_xtab(\n",
    "  x   = pmh2_med$pmh_medication, \n",
    "  grp = pmh2_med$pmh_problems , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"med1.jpg\", fig = med1)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9eb4b0cd-3aa1-42b5-b8d0-958671a8ecc3",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Family history 1\n",
    "\n",
    "fh21<-plot_xtab(\n",
    "  x   = pmh2_fh$Family_history, \n",
    "  grp = pmh2_fh$pmh_problems , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"fh21.jpg\", fig = fh21)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d3f20687-6ef5-4c88-a8c4-a1af392a14dd",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Family history2\n",
    "pmh2_fh<-pmh62%>%select(child_person_id,Family_history, pmh_problems)%>%distinct()\n",
    "fh2<-plot_grpfrq(\n",
    "pmh2_fh$Family_history, \n",
    "pmh2_fh$pmh_problems , \n",
    "legend.title = \"Indication for PMH problems\",ylim = c(0,30000), \n",
    " \n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)\n",
    "save_plot(filename = \"fh2.jpg\", fig = fh2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 209,
   "id": "beb253ad-742c-40e6-b5ca-f2f4b0a3bac2",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22m`summarise()` has grouped output by 'Family_history'. You can override using\n",
      "the `.groups` argument.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 4 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Family_history</th><th scope=col>pmh_problems</th><th scope=col>count</th><th scope=col>percent</th></tr>\n",
       "\t<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>no </td><td>yes</td><td>17690</td><td>98% </td></tr>\n",
       "\t<tr><td>yes</td><td>yes</td><td> 1618</td><td>100%</td></tr>\n",
       "\t<tr><td>no </td><td>no </td><td>  285</td><td>2%  </td></tr>\n",
       "\t<tr><td>yes</td><td>no </td><td>    3</td><td>0%  </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 4 × 4\n",
       "\\begin{tabular}{llll}\n",
       " Family\\_history & pmh\\_problems & count & percent\\\\\n",
       " <fct> & <fct> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t no  & yes & 17690 & 98\\% \\\\\n",
       "\t yes & yes &  1618 & 100\\%\\\\\n",
       "\t no  & no  &   285 & 2\\%  \\\\\n",
       "\t yes & no  &     3 & 0\\%  \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 4 × 4\n",
       "\n",
       "| Family_history &lt;fct&gt; | pmh_problems &lt;fct&gt; | count &lt;int&gt; | percent &lt;chr&gt; |\n",
       "|---|---|---|---|\n",
       "| no  | yes | 17690 | 98%  |\n",
       "| yes | yes |  1618 | 100% |\n",
       "| no  | no  |   285 | 2%   |\n",
       "| yes | no  |     3 | 0%   |\n",
       "\n"
      ],
      "text/plain": [
       "  Family_history pmh_problems count percent\n",
       "1 no             yes          17690 98%    \n",
       "2 yes            yes           1618 100%   \n",
       "3 no             no             285 2%     \n",
       "4 yes            no               3 0%     "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh62 %>% filter(Event_period==\"Postnatal\")%>% group_by(Family_history,pmh_problems) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%arrange(desc(count)) %>%drop_na()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 144,
   "id": "044d3b52-2912-477b-af0f-b59970a2832f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tibble [32,186 × 21] (S3: tbl_df/tbl/data.frame)\n",
      " $ person_id                                 : int [1:32186] 8448253 12655334 13424191 13542759 1040492 13122567 12647542 13371312 12905236 13670157 ...\n",
      " $ child_person_id                           : int [1:32186] 14993025 12601918 13185264 14989821 14992132 14993653 14990982 14992050 13071420 14780783 ...\n",
      " $ baby_year_of_birth                        : Factor w/ 7 levels \"2016\",\"2017\",..: 7 1 2 7 7 7 7 7 1 7 ...\n",
      " $ Ethnicity                                 : Factor w/ 3 levels \"White British\",..: NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ Employment                                : Factor w/ 4 levels \"Employed\",\"Unemployed and seeking work\",..: 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ support                                   : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ physical_disability_code_mother_at_booking: Factor w/ 2 levels \"N\",\"Y\": 1 1 1 NA 1 1 1 1 1 1 ...\n",
      " $ mental_health_prediction                  : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 1 ...\n",
      " $ complex_social_factors_indicator          : Factor w/ 2 levels \"no\",\"yes\": 2 NA NA NA NA 2 NA NA 2 NA ...\n",
      " $ BMI                                       : num [1:32186] NA 32 18.6 33.5 NA ...\n",
      " $ smoking                                   : Factor w/ 3 levels \"Current smoker\",..: NA 3 3 3 3 3 3 3 3 3 ...\n",
      " $ folic_acid                                : Factor w/ 3 levels \"not taken\",\"start taking once pregnant\",..: 2 3 2 2 2 2 2 2 2 2 ...\n",
      " $ substance_abuse                           : Factor w/ 3 levels \"currently using\",..: 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Speaks_English                            : Factor w/ 2 levels \"No\",\"Yes\": 2 2 NA NA 2 2 2 NA 2 2 ...\n",
      " $ Interpreter_needed                        : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 2 1 1 2 ...\n",
      " $ IMD                                       : Factor w/ 3 levels \"most deprived\",..: 3 NA NA NA NA 1 1 NA 1 1 ...\n",
      " $ mother_age                                : int [1:32186] NA NA NA NA NA NA NA NA NA NA ...\n",
      " $ pmh_problems                              : Factor w/ 2 levels \"no\",\"yes\": 2 2 2 2 2 2 2 2 2 2 ...\n",
      " $ Family_history                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ pmh_medication                            : Factor w/ 2 levels \"no\",\"yes\": 1 1 1 1 1 1 1 1 1 1 ...\n",
      " $ Event_period                              : Factor w/ 3 levels \"Both\",\"Antenatal\",..: 3 3 1 3 NA 3 1 3 3 3 ...\n"
     ]
    }
   ],
   "source": [
    "str(pmh62)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8fc43f60-9cea-4ce1-8b74-41bef1629f95",
   "metadata": {},
   "outputs": [],
   "source": [
    "##logistic regression model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 119,
   "id": "e729e3ae-ce9a-46a2-87d1-fd5cdd7eaf67",
   "metadata": {},
   "outputs": [],
   "source": [
    "pmh62$Ethnicity <- relevel(pmh62$Ethnicity, \"White British\")\n",
    "pmh62$pmh_problems <- relevel(pmh62$pmh_problems, \"no\")\n",
    "pmh62$IMD <- relevel(pmh62$IMD, \"most deprived\")\n",
    "pmh62$Employment<- relevel(pmh62$Employment, \"Employed\")\n",
    "pmh62$Interpreter_needed <- relevel(pmh62$Interpreter_needed, \"no\")\n",
    "pmh62$Event_period <- as.factor(pmh62$Event_period) \n",
    "pmh62$Event_period <- relevel(pmh62$Event_period, \"Both\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 154,
   "id": "21d2ad9a-d591-446a-90ef-3c294faeff2b",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh_problems ~ Ethnicity + complex_social_factors_indicator + \n",
       "    smoking + IMD + Family_history + Event_period + substance_abuse, \n",
       "    family = binomial, data = pmh63)\n",
       "\n",
       "Deviance Residuals: \n",
       "   Min      1Q  Median      3Q     Max  \n",
       "-3.376   0.088   0.160   0.183   1.685  \n",
       "\n",
       "Coefficients:\n",
       "                                    Estimate Std. Error z value Pr(>|z|)    \n",
       "(Intercept)                           0.1107     0.5314    0.21   0.8350    \n",
       "EthnicityAsian Pakistani              0.0946     0.0808    1.17   0.2418    \n",
       "EthnicityOthers                      -0.1849     0.0847   -2.18   0.0291 *  \n",
       "complex_social_factors_indicatoryes   0.3512     0.1160    3.03   0.0025 ** \n",
       "smokingEx-Smoker                     -0.0135     0.1190   -0.11   0.9098    \n",
       "smokingNever Smoked                  -0.2439     0.0942   -2.59   0.0096 ** \n",
       "IMDleast deprived                    -0.0180     0.1551   -0.12   0.9076    \n",
       "IMDmoderate deprived                 -0.2960     0.1122   -2.64   0.0084 ** \n",
       "Family_historyyes                     0.9477     0.1036    9.15   <2e-16 ***\n",
       "Event_periodPostnatal                 4.9241     0.1094   45.01   <2e-16 ***\n",
       "substance_abusenever                 -0.5282     0.5351   -0.99   0.3236    \n",
       "substance_abusepreviously used        0.3104     0.5579    0.56   0.5780    \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 13346.1  on 12022  degrees of freedom\n",
       "Residual deviance:  6925.7  on 12011  degrees of freedom\n",
       "AIC: 6950\n",
       "\n",
       "Number of Fisher Scoring iterations: 7\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##whole data \n",
    "pmh63<-pmh62%>% filter(Event_period!=\"Antenatal\")%>%dplyr::select(Ethnicity , complex_social_factors_indicator,smoking,folic_acid ,IMD, Family_history\n",
    "                                                                  ,pmh_problems,Event_period,substance_abuse,BMI)%>%drop_na()\n",
    "# Fit the model\n",
    "modelproE <- glm(pmh_problems ~., data = pmh63, family = binomial)%>%\n",
    "  stepAIC(trace = FALSE) \n",
    "# Summarize the final selected model\n",
    "summary(modelproE )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 155,
   "id": "879971fd-5540-4d1a-9c3f-93dc9917a603",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                                           odds_ratio  2.5 % 97.5 %\n",
      "(Intercept)                          0.111       1.12   0.40   3.37\n",
      "EthnicityAsian Pakistani             0.095       1.10   0.94   1.29\n",
      "EthnicityOthers                     -0.185       0.83   0.70   0.98\n",
      "complex_social_factors_indicatoryes  0.351       1.42   1.13   1.78\n",
      "smokingEx-Smoker                    -0.013       0.99   0.78   1.25\n",
      "smokingNever Smoked                 -0.244       0.78   0.65   0.94\n",
      "IMDleast deprived                   -0.018       0.98   0.72   1.33\n",
      "IMDmoderate deprived                -0.296       0.74   0.60   0.93\n",
      "Family_historyyes                    0.948       2.58   2.11   3.16\n",
      "Event_periodPostnatal                4.924     137.57 111.69 171.57\n",
      "substance_abusenever                -0.528       0.59   0.19   1.65\n",
      "substance_abusepreviously used       0.310       1.36   0.43   3.99\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Profiled confidence intervals may take longer time to compute.\n",
      "  Use `ci_method=\"wald\"` for faster computation of CIs.\n",
      "\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "tableproE<-cbind(coef(modelproE),odds_ratio=exp(coef(modelproE)),exp(confint(modelproE)))\n",
    "print(tableproE,digits=2)\n",
    "proE<-plot_model(modelproE,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.1,300), vline.color = \"red\", title = \"Indication for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelproE.jpg\", fig = proE)\n",
    "write.csv(tableproE,\"tableproE.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 216,
   "id": "052eda42-d686-49eb-a608-eb9ffb8ee8d0",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh_problems ~ Ethnicity + folic_acid + IMD + Family_history + \n",
       "    BMI, family = binomial, data = pmh63a)\n",
       "\n",
       "Deviance Residuals: \n",
       "    Min       1Q   Median       3Q      Max  \n",
       "-3.5151   0.0753   0.1062   0.1797   0.6261  \n",
       "\n",
       "Coefficients:\n",
       "                                     Estimate Std. Error z value Pr(>|z|)    \n",
       "(Intercept)                           4.53775    0.57333   7.915 2.48e-15 ***\n",
       "EthnicityAsian Pakistani              2.07759    0.33947   6.120 9.35e-10 ***\n",
       "EthnicityOthers                       1.17274    0.29068   4.034 5.47e-05 ***\n",
       "folic_acidstart taking once pregnant -0.17221    0.35084  -0.491   0.6235    \n",
       "folic_acidtaken prior to pregnancy   -0.79663    0.37919  -2.101   0.0357 *  \n",
       "IMDleast deprived                    -1.18307    0.28552  -4.144 3.42e-05 ***\n",
       "IMDmoderate deprived                 -0.29089    0.31258  -0.931   0.3521    \n",
       "Family_historyyes                     2.28466    1.00791   2.267   0.0234 *  \n",
       "BMI                                  -0.02385    0.01630  -1.464   0.1433    \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 999.79  on 7435  degrees of freedom\n",
       "Residual deviance: 874.01  on 7427  degrees of freedom\n",
       "AIC: 892.01\n",
       "\n",
       "Number of Fisher Scoring iterations: 9\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##postnatal period\n",
    "pmh63a<-pmh62%>%filter(Event_period==\"Postnatal\")%>%dplyr::select(Ethnicity, smoking,folic_acid ,IMD, pmh_problems,substance_abuse,complex_social_factors_indicator,Family_history, mother_age,BMI)%>%drop_na()\n",
    "# Fit the model\n",
    "modelproA <- glm(pmh_problems ~., data = pmh63a, family = binomial)%>%\n",
    "  stepAIC(trace = FALSE) \n",
    "# Summarize the final selected model\n",
    "summary(modelproA )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 130,
   "id": "9248304a-a423-4e79-8915-c92060addca5",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh_problems ~ Ethnicity + folic_acid + IMD + Family_history + \n",
       "    BMI, family = binomial, data = pmh63a)\n",
       "\n",
       "Deviance Residuals: \n",
       "   Min      1Q  Median      3Q     Max  \n",
       "-3.515   0.075   0.106   0.180   0.626  \n",
       "\n",
       "Coefficients:\n",
       "                                     Estimate Std. Error z value Pr(>|z|)    \n",
       "(Intercept)                            4.5378     0.5733    7.91  2.5e-15 ***\n",
       "EthnicityAsian Pakistani               2.0776     0.3395    6.12  9.3e-10 ***\n",
       "EthnicityOthers                        1.1727     0.2907    4.03  5.5e-05 ***\n",
       "folic_acidstart taking once pregnant  -0.1722     0.3508   -0.49    0.624    \n",
       "folic_acidtaken prior to pregnancy    -0.7966     0.3792   -2.10    0.036 *  \n",
       "IMDleast deprived                     -1.1831     0.2855   -4.14  3.4e-05 ***\n",
       "IMDmoderate deprived                  -0.2909     0.3126   -0.93    0.352    \n",
       "Family_historyyes                      2.2847     1.0079    2.27    0.023 *  \n",
       "BMI                                   -0.0239     0.0163   -1.46    0.143    \n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 999.79  on 7435  degrees of freedom\n",
       "Residual deviance: 874.01  on 7427  degrees of freedom\n",
       "AIC: 892\n",
       "\n",
       "Number of Fisher Scoring iterations: 9\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "pmh63a<-pmh62%>%filter(Event_period==\"Postnatal\")%>%dplyr::select(Ethnicity, smoking,folic_acid ,IMD, pmh_problems,substance_abuse,complex_social_factors_indicator,Family_history, mother_age,BMI)%>%drop_na()\n",
    "# Fit the model\n",
    "modelproA1 <- glm(pmh_problems ~., data = pmh63a, family = binomial)%>%\n",
    "  stepAIC(trace = FALSE) \n",
    "# Summarize the final selected model\n",
    "summary(modelproA1 )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 217,
   "id": "42ec6330-be34-4db7-bacd-9f1950d454f0",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                                            odds_ratio 2.5 % 97.5 %\n",
      "(Intercept)                           4.538      93.48 30.88 294.31\n",
      "EthnicityAsian Pakistani              2.078       7.99  4.26  16.34\n",
      "EthnicityOthers                       1.173       3.23  1.87   5.89\n",
      "folic_acidstart taking once pregnant -0.172       0.84  0.40   1.60\n",
      "folic_acidtaken prior to pregnancy   -0.797       0.45  0.20   0.92\n",
      "IMDleast deprived                    -1.183       0.31  0.18   0.55\n",
      "IMDmoderate deprived                 -0.291       0.75  0.42   1.43\n",
      "Family_historyyes                     2.285       9.82  2.17 173.54\n",
      "BMI                                  -0.024       0.98  0.95   1.01\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "tableproA<-cbind(coef(modelproA),odds_ratio=exp(coef(modelproA)),exp(confint(modelproA)))\n",
    "print(tableproA, digits=2)\n",
    "proA<-plot_model(modelproA,\n",
    "  colors = \"blue\",   show.values = TRUE, vline.color = \"red\", title = \"Indication for PMH problems\",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelproA.jpg\", fig = proA)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ad174651-0fb8-40f7-aef4-96a86fd13caa",
   "metadata": {},
   "outputs": [],
   "source": [
    "str(pmh63b)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 220,
   "id": "1d4924f9-d413-4750-9cc5-18806ce7c686",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "glm(formula = pmh_problems ~ Ethnicity + smoking + IMD + substance_abuse + \n",
       "    Family_history + mother_age, family = binomial, data = pmh63b)\n",
       "\n",
       "Deviance Residuals: \n",
       "    Min       1Q   Median       3Q      Max  \n",
       "-1.9897  -0.9427  -0.8435   1.3228   1.8392  \n",
       "\n",
       "Coefficients:\n",
       "                                Estimate Std. Error z value Pr(>|z|)    \n",
       "(Intercept)                     1.025661   0.541320   1.895  0.05813 .  \n",
       "EthnicityAsian Pakistani       -0.092659   0.079853  -1.160  0.24590    \n",
       "EthnicityOthers                -0.386480   0.084519  -4.573 4.81e-06 ***\n",
       "smokingEx-Smoker                0.029331   0.118135   0.248  0.80392    \n",
       "smokingNever Smoked            -0.271498   0.093805  -2.894  0.00380 ** \n",
       "IMDleast deprived               0.413729   0.149087   2.775  0.00552 ** \n",
       "IMDmoderate deprived           -0.248793   0.114318  -2.176  0.02953 *  \n",
       "substance_abusenever           -0.586788   0.529402  -1.108  0.26769    \n",
       "substance_abusepreviously used  0.321030   0.554905   0.579  0.56291    \n",
       "Family_historyyes               0.921065   0.101361   9.087  < 2e-16 ***\n",
       "mother_age                     -0.024279   0.005539  -4.383 1.17e-05 ***\n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "(Dispersion parameter for binomial family taken to be 1)\n",
       "\n",
       "    Null deviance: 6733.1  on 5065  degrees of freedom\n",
       "Residual deviance: 6502.2  on 5055  degrees of freedom\n",
       "AIC: 6524.2\n",
       "\n",
       "Number of Fisher Scoring iterations: 4\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "##Both postnatal and antental period\n",
    "\n",
    "# Fit the model\n",
    "pmh63b<-pmh62%>%filter(Event_period==\"Both\")%>%dplyr::select(Ethnicity, smoking,folic_acid ,IMD, pmh_problems,substance_abuse,Family_history, mother_age,BMI)%>%drop_na()\n",
    "modelproB <- glm(pmh_problems ~., data = pmh63b, family = binomial) %>%\n",
    "  stepAIC(trace = FALSE)\n",
    "# Summarize the final selected model\n",
    "summary(modelproB )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 221,
   "id": "435d56bb-decc-4a10-b643-d6d61a3dd271",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Waiting for profiling to be done...\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                                      odds_ratio 2.5 % 97.5 %\n",
      "(Intercept)                     1.026       2.79  0.98   8.55\n",
      "EthnicityAsian Pakistani       -0.093       0.91  0.78   1.07\n",
      "EthnicityOthers                -0.386       0.68  0.58   0.80\n",
      "smokingEx-Smoker                0.029       1.03  0.82   1.30\n",
      "smokingNever Smoked            -0.271       0.76  0.63   0.92\n",
      "IMDleast deprived               0.414       1.51  1.13   2.02\n",
      "IMDmoderate deprived           -0.249       0.78  0.62   0.97\n",
      "substance_abusenever           -0.587       0.56  0.19   1.54\n",
      "substance_abusepreviously used  0.321       1.38  0.44   4.02\n",
      "Family_historyyes               0.921       2.51  2.06   3.07\n",
      "mother_age                     -0.024       0.98  0.97   0.99\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<strong>png:</strong> 2"
      ],
      "text/latex": [
       "\\textbf{png:} 2"
      ],
      "text/markdown": [
       "**png:** 2"
      ],
      "text/plain": [
       "png \n",
       "  2 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "tableproB<-cbind(coef(modelproB),odds_ratio=exp(coef(modelproB)),exp(confint(modelproB)))\n",
    "print(tableproB,digits=2)\n",
    "proB<-plot_model(modelproB,\n",
    "  colors = \"blue\",   show.values = TRUE, axis.lim = c(0.001,300), vline.color = \"red\", title = \"Indication of PMH problems \",\n",
    "value.offset = .4,   value.size = 2,   dot.size = 0.5,   line.size = 0.5,   width = 0.5)\n",
    "save_plot(filename = \"modelproB.jpg\", fig = proB)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7fdd69af-a404-48ef-bf43-6d65b170c20f",
   "metadata": {},
   "outputs": [],
   "source": [
    "##???????????????????? should we add this\n",
    "##indication of depression\n",
    "##cleaning the data (if have both yes and no for deprssion choose only yes)\n",
    "pmh3_true<-pmh_final%>%filter(depression==\"yes\")%>%distinct()\n",
    "pmh3_false<-pmh_final%>%filter(depression==\"no\")%>%distinct()\n",
    "pmh3_false1<-anti_join(pmh3_false, pmh3_true, by=\"child_person_id\")%>%distinct()\n",
    "pmhd<- bind_rows(pmh3_true,pmh3_false1)%>%filter(event_year!=2015)\n",
    "\n",
    "###using the original data\n",
    "dep<-pmh4%>%  group_by( baby_year_of_birth,depression) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()%>%\n",
    "ggplot( aes(x=as.factor(baby_year_of_birth), y=count, fill=depression)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=-0.2, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ \n",
    "  theme(axis.text = element_text( \n",
    "    angle = 90,    color=\"black\",    size=10,     face=2)\n",
    "  )+xlab(\"YEAR\")\n",
    "save_plot(filename = \"dep.jpg\", fig = dep)\n",
    "###using cleaned data \n",
    "pmh4d<-pmhd%>%select(child_person_id,baby_year_of_birth, depression )%>%distinct()\n",
    "\n",
    "plotdep<-plot_xtab(\n",
    "  x   = pmh4d$baby_year_of_birth, \n",
    "  grp = pmh4d$depression , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"plotdep.jpg\", fig = plotdep)\n",
    "\n",
    "\n",
    "plotdep1<-plot_xtab(\n",
    "  x   = pmh4$baby_year_of_birth, \n",
    "  grp = pmh4$depression , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"stack\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = TRUE)\n",
    "save_plot(filename = \"plotdep1.jpg\", fig = plotdep1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b016dfda-ced3-40f2-9f7c-7d5809ad9e3d",
   "metadata": {},
   "outputs": [],
   "source": [
    "######other analysis ????????????????????????????"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "242e2115-212f-449c-96f3-e0ea46e1d217",
   "metadata": {},
   "outputs": [],
   "source": [
    "####Should we add this???????????????????????\n",
    "##cleaning the data (if have both yes and no for anxity choose only yes)\n",
    "pmh5_true<-pmh_final%>%filter(anxiety==\"yes\")%>%distinct()\n",
    "pmh5_false<-pmh_final%>%filter(anxiety==\"no\")%>%distinct()\n",
    "pmh5_false1<-anti_join(pmh5_false, pmh5_true, by=\"child_person_id\")%>%distinct()\n",
    "pmhan<- bind_rows(pmh5_true,pmh5_false1)%>%filter(event_year!=2015)\n",
    "###indication for anexity\n",
    "\n",
    "anx<-pmhan%>%  group_by( baby_year_of_birth,anxiety) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()%>%\n",
    "ggplot( aes(x=as.factor(baby_year_of_birth), y=count, fill=anxiety)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=-0.2, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ \n",
    "  theme(axis.text = element_text( \n",
    "    angle = 90,    color=\"black\",    size=10,     face=2)\n",
    "  )+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"anx.jpg\", fig = anx)\n",
    "\n",
    "\n",
    "pmhan4<-pmhan%>%select(child_person_id,baby_year_of_birth, anxiety )%>%distinct()\n",
    "\n",
    "plotanx<-plot_xtab(\n",
    "  x   = pmhan4$baby_year_of_birth, \n",
    "  grp = pmhan4$anxiety , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"plotanx.jpg\", fig = plotanx)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3bcf5edd-5320-45ee-802a-40e3683b0e9f",
   "metadata": {},
   "outputs": [],
   "source": [
    "##Should we include this?????\n",
    "\n",
    "##cleaning the data (if have both yes and no for pmh_diagnosis choose only yes)\n",
    "pmh7_true<-pmh_final%>%filter(pmh_diagnosis==\"yes\")%>%distinct()\n",
    "pmh7_false<-pmh_final%>%filter(pmh_diagnosis==\"no\")%>%distinct()\n",
    "pmh7_false1<-anti_join(pmh7_false, pmh7_true, by=\"child_person_id\")%>%distinct()\n",
    "pmhdi<- bind_rows(pmh7_true,pmh7_false1)%>%filter(event_year!=2015)\n",
    "\n",
    "###diagnosis of perinatal mental health problems\n",
    "\n",
    "dia<-pmhdi%>%  group_by( baby_year_of_birth,pmh_diagnosis) %>%\n",
    "  summarize(count = n_distinct(child_person_id))%>%mutate(percent=scales::percent(count/sum(count)))%>%drop_na()%>%\n",
    "ggplot( aes(x=as.factor(baby_year_of_birth), y=count, fill=pmh_diagnosis)) +\n",
    "  geom_bar(stat=\"identity\", position=position_dodge())+\n",
    "  geom_text(aes(label=percent), vjust=-0.2, color=\"black\",\n",
    "            position = position_dodge(0.9), size=2)+ \n",
    "  theme(axis.text = element_text( \n",
    "    angle = 90,    color=\"black\",    size=10,     face=2)\n",
    "  )+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"dia.jpg\", fig = dia)\n",
    "\n",
    "\n",
    "\n",
    "pmhdi4<-pmhdi%>%select(child_person_id,baby_year_of_birth, pmh_diagnosis )%>%distinct()\n",
    "\n",
    "plotdia<-plot_xtab(\n",
    "  x   = pmhdi4$baby_year_of_birth, \n",
    "  grp = pmhdi4$pmh_diagnosis , \n",
    "  margin  = \"row\", \n",
    "  bar.pos = \"dodge\",\n",
    "  show.summary = TRUE,\n",
    "  coord.flip   = FALSE)+xlab(\"Baby Year of Birth\")\n",
    "save_plot(filename = \"plotdia.jpg\", fig = plotdia)"
   ]
  }
 ],
 "metadata": {
  "environment": {
   "kernel": "ir",
   "name": ".m112",
   "type": "gcloud",
   "uri": "gcr.io/deeplearning-platform-release/:m112"
  },
  "kernelspec": {
   "display_name": "R",
   "language": "R",
   "name": "ir"
  },
  "language_info": {
   "codemirror_mode": "r",
   "file_extension": ".r",
   "mimetype": "text/x-r-source",
   "name": "R",
   "pygments_lexer": "r",
   "version": "4.2.3"
  },
  "toc-autonumbering": true,
  "toc-showcode": true,
  "toc-showmarkdowntxt": true
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
